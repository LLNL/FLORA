subroutine adummy
Crsi,, Cliche storage set up here

cliche param

parameter
parameter
parameter
parameter
parameter
parameter
parameter
endeliche

(tzx*66, Jrx=30, [zexeeizx-2  )

( itbwe2kizxn-1  )
(Kepeltzxer2)#lprxe2), tbowatzx-1 )
(np lt=3000, nps=100 )
(ixpfeAe(tzx-2) ,nfourxf=150)
(ixpgrekizxe)

(ka tm] }

cliche fstor

use param

common/fun/flltizx Jrx) fallax Jrxl, f3ltzex, Jew), faltex, Jen)
¢ ,fBCtax,jrwl f7 tex, Jew,

ec glltax,Jrx) gellax,Jrxl , g3llax .irxl g4ltzex,jex)

c ,swgl,swg2,swg3,swa4

common/equil/bltzx,Jrxl rholiex,Jext,qublizgnu,jereilirltzx, jee
¢ ,philtex gered, yyyltew jew) xaxxllax,Jrwl,qvilax,jrxl
common/pertur/xtoal(kxp) xlotkxp)] xlollkxp]

¢ ,xroo(kxp),xrofkxp],xral(kxp)

endcliche

cliche matrix

use param

common/coeff/all(kap,9) ,adlkxp,9),adtkxp,9) bi (kxp, 3)
ec ,rhstikxp),chs2l(kxp!)
Crees tNnamed common for dynamtec memeory expansion
common ww(1], wwill]

endcliche

cliche const

use param

common/title/aname (5)
comman/con/gaml,game,tx,Jx mm, tzxo,Kkxx,mmax, lmax,isw, thbw
c ,facl, face, blas,du,dv,dt,ndiag,ex0,60,rhoO,exl, fil, fizx, fj
c ,fjrx,kplot npm,.fpsi,fz,fu,fv,azm,apsim,u0,v0, amass
¢ ,fourp!,omegst,omegr omegexb fir ,sf6,sfB,kKplotm,kzs, zedge
c ,¢puo,cto,syso,valfk,xu, xv in, pl, vw.pstw,dvin,dvout
common/contm/
pslOrel,psitrel psi2rel,zirel,z2rel,z3rel,z0rel .nslosh, bing
incenter pslosh,pcenter,rp,ztrans, |ltrans,bm, ltran,ztran.rpl
ibcen, pring, ,epsp,phicen, phiplg kin, xpot,ypot,wpot,pfudge,rpx

,betcene,betslse,psloshe,pcentee,bmax,alsi,bmi,psist,cold
ipewide,psi3rel,psi3,pimax,bv0,bv3,bv4, beeng psloshin, psloshen

G
c
C
c ,phice,phip! betslsh, betcent,z0,21,22,23,z4, psil,psi2,psid
c
c
c

> »ns sshin,pxpl,pxp2,p3a,p3b,puc p3d,psim,pel0,ael bel ,cet
c ,psiOerel ,psiOe,psime peewide,wpe2e pefloor, pifloor pefilag
c ,fring, long,no3d,nold
common/mesh/pstl(jrx),zlizx),ulizel vijerx) dpstljrxl dzlizx])
e ,vpsiljex) uuzl(tzx) ,.vpsthl(jrx) ,uuzhitzx)
common/graf/ xrtimel(nplt),xrspzlizx,nposl,xrsppst(jrx,2knps)
c ,time(npltl,xflutelizx,nps]
common/curveo/er, lb,rw,beta0,delrho,stable,an0,cee,rQ,
ec echarg,omegt,omege,enl,besarg,zal,dtrel,p0,omegO
c ,omanal,omandaed,groana, theta .
common/tmeon/hi2lizx) hllizx) H34(izx),abplizx|] .bbplizx)
c ,cbpltzx), abflizx) ,bbflizx),cbflizx) .hp3ljrx) hbpletjrx)

¢ ,htrans(tzx) ,abqlizx) .bbgqlizx) .cbqlizx) ,h56lizx) abel itzx)

e ,bbritze),cbre!izx) betring, hpOljrx) bpm jrx) ,hpmeljrx)
common/tmflield/bvacitzx) ,dbvdzlizx) ,débydz2lizx) ,dptdpst(jrx!

¢ .ptljrxd pikiksim,jrxd bpkle(ksim) hpkOlksim! ,delilt(ksim)

ec ,deli2tkstmi deli3i(ksim) delidl(ksim) .pzzlizx,jrx) ,dbdpsilizx,jrx)

e ,phitlizxi phtalizex) pperplizx.jrx) pparlizx,jrxl dfluted(tzx!

¢ ,qubv(izx jrx), peljrx) dpedpstljrxn) ,dflutetlizx) ,dflute2lizx)

e ,flutel(jrxl, flutealjrxl flute3l(jre) pakiksim,jrx) deliSlksim)

c ,pperps(tzx,jrxl,errprplizx,jrx)rerrprillizx2,jrx-1)

ec ,pperpelizx,drxl.epstlizx,jJrx},omegtwkbljrx), omegawkbl(jrx)

c ,gamwkbljrx) dfluted(izx)] ,rhoaveljrx) xxxavel(jrxl,yyyaveljrx)

e ,petljrx) .dpedpstlJrxl ,p3lf[rxl,dp3dpsiljrx) Apkmikstm!)

ec ,hpkmelksim!)

common/forzed/nfour ,nfourx,nfourmax .nfourp, }four,txp, locv

real Ib, ,ltrans,ltran,nslash,ncenter ,nsloshin
endcliche

return

end
Creevee the main routine
Crreee NOttce of 4/8/82, this verston runs correctly for {tswet, and
Ceoreee PUNS Correctly for tswe-1 ,
c.,..+,5/12/82, flora runs testcase i , 0 beta, 0 pressure, homogeneous
Crsvee plasma, correctly,
Cosreese floral transforms variables z.,pst to u,v which are always equally
Criee, Spaced, transformation: zeauktut#xu, and psizapsitvttxv, where
Coseey ZMAx=UMAXK, PSIMAax=vmMax, and Fz*zmax=futumax, fposi*pstimaxzfv¥vmax ,
Goseas fz, fu, fost, fv, input, wxustln fz 7 In fu, xveln fpst 7 In fv,
Cues ausumax¥#(-xxe1) , apst=vmaxtel-yyel) ,
Cisers flora2 solves test case 2 , rotating rigid rotor stability, ref:
c..,,. freitdberg and pearlistein, phys fFlutds 21(7) july 1978 1207
Cressy florad tneludes background constant density, enbar ( as does flora3 },
Cioseys And kzs switch which when set *o zero, generates initial perturbations
C..ee+ Independent of z in random spatial generator (ex0=1,)
C..ae. florad
Cy.... ¢S vectorized version of florad, (calls rightyec instead of
c..... right 1, also has timing routine from bb. langdon (requires
c..ass bzohar loaded as a binary |),
C..eees Insert cliche storage here
c..... flora? is mod. flora5, with psi stretching function
C.ces. exactly centerad tn amat. (flora used linear Interpolation
Cisess to get vpsil(j+l/2)). Also revised diagnostic plots tncluded.
c....,floral2 is floral! (rigid rotor with corrected equil. and
C.ss., Corrected curvature terms (floraiO)) with fourter mode analyses
c.,... @dded ( using cpft and reft) and data for zed post processing.
c.....a@dditional tnput data: jfour (v index at which xr fs analyzed In

c.....2 1, nfourp ( analyze xr every nfour’th time step },nfourmax

Crease (number of times the buffer is read to the history filel, note
Cesena xP JS extended a factor of 4 to look lithe a periodic full wave
Cireee for cpft, If jfour ts tnput 0, code sets it to jx/4.
c
Crsersfloral3 is floratle2 with curvature driven flute mode equilibrium
cy.,,,fequilrot replaced by equilcur, rigidcon replaced by curvecon }
c,,,.,floratm, tandem mirror equilibrium
c
Cysyeyflortmt, tandem mirror equilibrium, with 3-d plot of equilib,
¢ quantities added, ( uses tv80 and graflib |
Crsreerflortex, tandem mirror equilb, with corrections to flortm1, In-
Coreen e PUK Switches swal, swg2@ swg3, swa4 added,
Ceoresaflortm2, like flortex with revised electron ring, a la D'tppolito
C.sye-lerring pperp in b field only, and additianal term in curvature
Cyree, Grtve |,
cys flortm3, Like flortme with corrections to pressusre normalization,
Cryveey AND Additional diagnostics, ( 3-d plots of curvature drive-e ring
Craee, term, and perp, pressure balance check } , also 3-d plots of
Cii,es pparalle!l pressure check, and e-ps! (=-dphi/dpsi |] , Phi2 modified
Corea, to = T,-(pst/psi3dieeypot ,
Cissesflortm4, modifted plasma pperp with addition of p3lj} to give
Cyseee @ posttive slope near the center,
Corer flortm5, modified pl in flortm4 to be two functions, pel and
Cores y pO2, Jotned at psime with equal slope and value.pel=ael+bel*(
C.,,., psl/psimeltcel#ipsi/psime)**#2, and pe2=,5#(i-tanhiipsi-psi0e)l/p2ewide) |
c
Crosses flortm6, modified flortm5 as follows: for pe2lipsille. to p2flag ( an
c. .. Input valuel, p2 set to pefloor lan tnput value) and pl set to
e,  . plfloor (an tnput valtuel, Long-thin ertng option added, This modifies
C.,++, 6b dependence of ering pperp to took longer (by changing abf, bbf, cbf)
teaeee Tf long ( an tnput value } = 1, otherwise leaves pperp of ring un-
Crises Changed, Plot output options, nold=1, prevents graflib plots, no3d=1
Crises prevents tv80lib 3d plots,
¢

use param

use fstor

use matrix

use const

data tim/1,e6/

Integer tallyb!(2000b)

common / qBlocs/iocf (0:15)

common/picl00/npete

data itally/1/
C...,,,¢all tink call here

call linkl'unit5S9=eterminal ,unit2=(infltm6,open) ,unit3=loutput,
c create! //')

if{ttally,gt,0) then
do 200 it=1,15
200 itfliocflitl,eq.Olgo to 210

i+ =Q

210

foctallysit

joctally=14

ifl(loctally,eq, Oligo tea 299

call timer(toctally,'’ztallyQ0O'’,tallyb,2000b,floratim,1)
299 «ttally=-1

endif

Iswel

iflizx. gt ,Jrxiiswe-]

jtbw= 5a(telswlkitows Sal t-iswlt(2ejrx- 1]

thbw= ,5S¢(T+iswltibwe Sel t-iswltljrx-t)

nn=j}tbwtkxp

nntejtbwekxp

call memory(lwwinn-1)

call memorylwwilnant ant)

namelist/noplot/nold,no3d

call ddil(noplot,2,0,1)

tflnold,ne,licall pstartidev 4rplot,1,'box u2l$'.1)

npete=]

iflnoid,ne. tical! pidd

call tnput

call inputtm

call rigtdcon

call curvecon

call arid

call constant

call tmeon2

call equlitm

call equilrot

call equilecur

call filtoll

call amat

call comatiww,jtbw)

call inittal
coey Spectal verston for testing fourter analysis and zed file
ceeey maker

call fourplay

call fourter

call mymovelxrol(1),xrol1),kKxex]

call mymovelxtol(t),xtol(1),kxx]

call mymovelxrool(1),xrol(t),kxx!)

call mymovelxioolt),xto(tl kxx]

call banfactkxp, thbw,wwit,-(kKxp-1))

t=O,

do 100 n=1,nmax

t=t+dt

time(n}=t

fact=-1,/dt

fac2=1,/dt

do 90 1=0, Imax

call rightvec

call zmovewrdiwwill(nn} rhs! kxx)

call bansol(kxp, thbw,ww,1,-(kxp-1) .wwt (nn) )

do 10 j#2,jx-]

kp=ltizxp*(j-2)

call zmovewrd(xrol,wwilnn) ,Kxx)
10 continue

call zmovewrd(wwil(nn) ,rhs2,kxx!

call bansol(kxp, thbw.ww,1,-(kxp-1),wwllnn))
do 20 jz#2,jx-1
kKp=i+kxp*(j-2)

call zmovawrd(xiol ,wwllnan) ,kxx)
20 continue
faciz=-,5/dt
90 faca= ,S/dt

call zmovewrd(xtoo,xio,kxx)

call zmovewrd(xto,xlol,kxx)

call zmovewrd(xroo,xro,kKxx]

call zmovewrd(xro,xral,kxx)
Cysyuy time array

xrtimel(nisexrol(kplot)
tf lmodin,nditag!,eq,Olceall diagno

if(modin,nfourp),eq,Qlcall fourier
100) continue
call elsdsk(tocy,Q}
call timeused(icp,io,isy)

cpyoztecpeti
cloztot®tim
sysozlsyktio

if(nold,ne.1)
ec call picsher
call close(100)

if lno3d,eq,tlgo to 300
call Keep80(1,3)

call frBO0id

call threed

call plote

300 continue
call timend
call exit(1)
end

subroutine constant

Crsias Insert storage cliche here
use param
use fstor
use matrix
use const

gaml=,254(3*biasel]
gam2=,25¥(1-blas]

tp=,5#tx-2)

jp=,5*(]x~2)
kKpleip-1+(jp-2)¥*(ix-2)
kp2=jp-le(ju-2)elip-2)
kplot=,5#(1¢tswltkpl+ Sti l-iswltkp2
if(kplotmne .Olkplot=kplotm

return
end

subroutine curvecon

c,.,, calculates constants necessary for curvature driven
Cosaa flute mode case,
Cress, Insert storage cliches here

use param
use const
real kibsq

Cw

Ceoeeee Input for curvature driven flute case

data echarg/4,8e-10/7, enO/1,O0e+12/, bO/1,e4/, amass/3, 340e-24/
ec , cee/3,e10/, stable/,4/, fourp!/12,56637/, pi/3,1415926/
¢ , delrho/,05/,dtrel/,02/,xm/3,8317/, theta0/1,570796/
namelist/curve/bO,beta0,delrho,stable,enO,echarg, lb,rw,xm
¢ ,zol,dtrel, thetad
call ddilcurve,2,3,1)
lf lnold,ne, 1) call
zmaxezol*#lb
pO=betadtbOevot 5
psimax=rwkseetbde 5
amegOsq=bOse2/lenOtamasstibere2)
omegO=sart lomegQsq)
agt=1,-2,#delrho/xmer2
kKlbsq=Q0,
ifikzes.ne,Olklbsqz(pi/l(2,%zol))%¥2
delomeg=0,
if(sfB,ne,0)
1 delomeg=stabletl (betad/umet2-k lbsq/mmee2)/lagt#sfB8)41.-sfb¥agl/
2 sf8)tomegQsq
omegl=omegOtsart(delomeg)
omege=omegi-2esaqrtidelomeg!)
dt=dtrel/omeg!
ent=2,%*enOtdelrho/rwtt2
ultx)szmax
vijxl=psimax
dusultx)/(ix-1,5)
dvevijx)/tjx-1,5)
besarg=(xm/rw)

ddolcurve,100,0,1)

Creare Calculate analytic growth rate

onan aon

oo

tsfb=tan(theta0#* 5) 4sf6
radical=((aglemm*tsf6) #424 (omegltomeg2 |! *¥2-4, 4% 1 (omegl tomeg2tag)
c *sfBromegOsqtbetad/xmtt2) tmmet2-k lbsqtomeg0sq! |
iffradical,Ilt,O)lgo to 5

rootssartlradical,
omanalz=agl*tcfbtmm*t(omegttomegel* S+raot*,5
omanadc=omanal-root

groana=Q,

return

continue

omanalzagl¥tsfbemm*(omegltomegel*,5
groana=saqrtl(-radical)*,5

omana2=0,

return

end

subroutine Inputtta

calculates grid quantities needed by sub. grid
. tn floratm version

ries tngert storage cliches here

use param
use canst
real klbsq

...glossary of input parameters

psitOrel,.value of psi (tn relative units! where plasma pperp
profile ts half the maximum,
p2wide..parameter inversely proportional to “ramp width” of p2

psiQerel,.realitive value of psi where ering pperp (ped) is half

roononnnnnnnananaAanannanaAnnnnnnaaAnAananaana

Pe

o4

4

’

the maximum

peewide, parameter inversely proportional to “ramp width" of pe2
pstirel,, lower limit of psi where pring =0,

psl2.,upper limit of psi where pring=0,

zOrel,,axial center of plug

zirel,.,axial pasition of plug Inward mirror

zérel, ,axtal position of plug outboard mirror

z3rel.,tnner axtal position where pring=0,

z4rel,,outter axial position where pring=0,

nslosh, peak sloshing ton number density

neenter, peak center cell ton density

betslsh,,,peak sloshing ton beta-perp wor.t, bvac(z0)
betcent,,,peak center cell ton beta-perp wor .t, byac(z=0)
betslise,,.peak sloshing electron beta-perp wor,t, bvac(z20)
betcene,, peak center cell electron beta-perp wor.t, bvac(z=0)
betring.,,peak electron ring beta perp w.r,t, bvac(z0!
rp,.,plug vacuum mirror ratio

ztrans,,.begining of center cell transition region
ltrans,,,transition length

bmg..,,vacuum mirror peak (approx, | in gauss
beeng,..center cell bmax in gauss

epsp,..minimum pressure, below which b=bvac
phicen,,,.center cell potential relative to plug ion t perp
phiptg...plug potential relative to plug ton t perp
kKin.,,number of points | nm sismsons rule quadratures
xpot,,.exponent coefficient In center cell potential
wpot.,,exponent coefficient In plug potential

ypot...,power of polynomial tn potential pst dependence
pxpl...,power of polynomial tn e ring pperplpsi) (pllpsi))
epxp2,..power of polynomial tn e ring pperplipsi) (plilpsi))
zmax,..,axtal end of system in cm,

pelO= e ring pperp at psi=Q.

peflag,,.value of p2 at which pe is set constant
péefloor,., constant used in conjunction with p2flag
pifloor.,,constnt for pl used in conjunction with peflag

. Input for tandem mirror equilib,
data echarg/4,8e-10/, enO/1,.006+12/, bO/1,6€4/, amass/3,34e-24/
, cee/3,e10/, stable/.4/, fourpi/l12.56637/, pt/3.1415926/
,xpot/t,/,ypot/2,/,wpot/2.,/,kKin/S/psitrel/2./,psi2rel/1 .5/
ppstOrel/.50/,zmax/100./,zirel/.5/,z2rel/i./,z0rel/.75/
.z3rel/,625/, zd4rel/,875/,ztrans/,4/,ltrans/,.05/, pewide/,1/
,bmg/1,e4/, beeng/1.e3/, nsloshin/2.e13/, ncenter/1.e13/,
betsish/,25/, betcent/.10/, rp/4./, epsp/l.e-6/,rpl/2./
rphicen/.1/, phiplg/.1/7, betcene/,1/7, betslse/,1/
,dt/1,e-5/, pfudge/0./, cold/1,e-5/, betring/0./,psi3rel/1 ,05/
spxpt/2.7, pxp2/2,/, safe/.9/, pel0/0,/,psiOerel/.5/,p2ewide/.2/
pefloor/0./,plfloor/0,/,peflag/1.e-3/7,fring/.9/, long/1/,no3d/0/
»nold/0/
namelist/curve/echarg, lb,rw,xm.crw!l
,zmax,dt,theta0,pfudge
.psiOrel,ztrel,z2rel,2zOre!l,nstoshin,cold,z3rel!l.z4rel
incenter ,bets|ish,betcent,rp,ztrans, ltrans, bmg rpl
c ,bceng.#psp,phican,phiplg Kin, xpot,ypot,wpot ,betcene,betsise
c ,betring,psitrel,psi2rel pewtde.psi3rel,pxp!],pxp2,safe,pel0
c ,péewide,psiOerel p2floor ,p2aflag, pifloor, fring, long
call ddilcurvs,2,3,1)
if(nold.ne.1) then
call pframe
call p100

aonannaankana

Orn

call ddolcurve,100,0,1)
end If
Crees, transform tnput 2 Into physical units
zO=zOre|l*zmax
zl=zlrel*tzmax
z2=z2rel#zmax
z3=z3re|l¥zmax
z4=z4reltzmax
ztran=ztranstzmax
ltran=ltranstzmax
bm=bmg/saqrt(4,¥pi}
been=bceng/sqrtld, tpi}
Croeves Qererate zmax, psimax, ulix) ,vljxl, du, dv
asq=,25/((2,%rp)ee(2./3,)-1, )¥(z2-21) #82
argtl=¢(z1l-ztrani/itran
bvOzbme(1.7(1,¢( 20-21) 88 2/asq) ee). 541,/(1,4+( 20-221 882/asq)
c **1,5)
bmax=bmelt,41.7(1,¢ 021-22) 882/asq) 41,5) +bhcent, 5%
¢ (1.-tanhlargtt))
bv4=bme(1,/(1,4 021) 882/asq) eel 541 ./11,+(22)6#2/asq) 441.5)
psimax=rwkt2ebmax® 5
psiw=rwlt*2tbmax#t 5
pstO=psimaxtpsiOre!
psi0e=psimaxtpsiQere |
psi3=psimax*psi dre |
psil=psimaxtpsiire|l
psi2=psimaxtpsi2re |
v(jxl=psimax
ulix)l=zmax
duzultx)/lix-1,5)
dvev(jxwl/(ju-1,5)
C.,,.+..transform input constants from relative to physical units
pmagO=(bvO)ea28 5
pmagl=(bvatbeen) *e24% 5
psloshin=(betsish) *pmagO
pcenter=(betcent) t*pmag!l
psloshen=betslsetpmagO
pcentee=betcenetpmag!l
pring=betringtpmagO
phice=phicentpsloshin/(nsloshintecharg]
phipl=phiplg*psloshin/(nsloshintecharg!)
c,...calculate maximum pllpsi)
psidif=psi2-psil
pimax=(pxpltpsidif/((pxpl+pxp2ltpsit)) ttpxplelpxp2tpsidif /
c ((pxpl+pxp2)tpsi2) )¥*pxp2

c,...,check that kin [ts not too big
ksimp=ksim
if(kin.gt.Ksimp!] then
kin=ksimp

write(59,200I}kin
200) formatl'’kin tnitially too targe, reduced to',i4)
end if
C..ase Check that kin its odd for simpsons quadratures
kch=mod(kin,2)
if (kKcoh.eq. 0} then
kin=kin-1
write(59, 201 )kin
201 formatl’kin initially even, changed to',14)
end if
c..... adjust epsp to accomodate zero pressure case

epsp=epsp#(1.e-dAspuloshinepcenter!/(1,e-Btepsptpsloshintpcenter |

sea eetheck that been and betcen are physically consistent
asq=,25/( (2, rp) *412,/3,)-1, el z2-21) «482

bvO=bme(1.7(1,¢4( 20-21) 8#2/asqi #41 ,541,/11,4(20-22)482/asq!)

c¥e1,5)
argt3=(z3-ztrani/itran

bv3=bmel 1 11,4 23-21) e82/agq) eel Set 7/11 ,¢123-22) %82/asq)

c#e] 5S)ebcent 5411 ,-tanhlargt3} |}
rpx=bmax/(bv0)

rp3=bv3/bv0

afaczlrpel(1 .-1./rpeke) | ek2/bmea2
afact=(rpel),-1,/rp3ee2) )eae/bmeae
tcon6=pring/((1.-1,/rpaee2) 482)
tminzafact(bcentbv4) 82

if(tmin, le, betcent+betcene) then
beenl=sart((betcent+betcenel/afac)-bv4
tmine=tmin-betcene
write(59,210)bcenl,tmine

210) format( initial central cell beta and b are inconsistent for’,
e¢ ° equlibrium'’,/'either increase bcen to more than’,e14,6/
c ‘or decrease betcent to less than’ ,e14.6/'use namelist',

’

c data format’)
name!list/better/betcent,bcen
read(59,better)
pceenter=betcent*pmagOd

end if

tease Check plug ton beta and e ring beta

tminlz=afactbyOr82

if (tmint le. (betslsh+betsisell then
tbetsl=tmini-betslse
thetr=(-betsIishttminl}
delbet=betsishtbetslse-tmint
writte(59, 220) delbet,tbets!,tbhetr
namelist/fix/betsish,betslse

220) format('the sum of (betsish+betsise! is too large by’,

c @14.6/‘etther decrease betsish to',e!4,6/' or decrease

c betsise to’,e14.6/'or something (use namelist data format) ’]

read(59, fix)
psltoshin=bets|lsh¥pmag0
psloshen=betslsetpmag0
end if

wa, check betring In plug
ifltcon6.ge.(safet,.5tbvO#8e2) lthen
ratio=safet StbvOebte/tcon&
pring=pringtratio
ratinv=l./ratio
write(59,231)ratinv pring

231 format(‘pring was too large by a factor (',e14.6,°),
c' reduced to ',e14,6 )
end if

waa. check ti at rpl is less than rpx
iflrpi.ge.rpxithen
rplterp!l
rpi=.5%*rpx
write(59,230)rpit,rpx,rpt
230) format(’rp! (',e12.6,') was larger than rpx (',e12.6,
c' reduced to ',e12,6 )
end if

and was’,

"), and was’,

and
subroutine tmcond2d

C.e,,. Calculates equilibrulm quantities for tandem mirror

GCreees tnsert storage cliches here
use param
use const
real klibsq

ci... Calculate heaveside step functions h1l2, hl, h34
call beast (ht2(1),0.,1%«)
call beast(hi(1),0.,t«]
call beast(h34(1),0.,i«)
call beast (htrans(1),0,,t«)

do 2 te1,tx
if(zCil.ge.zt.and zlil le, ,z2lhi2lils=
(z(t) le, ztihtlide=t,
iflzlil,ge.ztranthtrans(ij=1,

2 ifizlil,ge.,z3,and.zlil le, zA4lh3a4tile=t,

psim=psiQs(1.-p2wide)
psime=psides(1,-plewide!)
c..,.,calculate heaveside step functions hpOlj), hp3ljl and hpi2(;)

call beast (hpl2(1),9,,jx)
call beast (hp3l(1),0.,jx]
call beast(hpO0(11,0.,J«)
call beast(hpm(t),0,,jx)
call beast ihpme (11.0. 1x)

do 4 j=1,
ifipsily), le.pstO)hpOljl=1.
if(psiljl te.pst3ihp3ljl=l,
if(pstlj) ile. psimihpm(j)et.
iflpsilsl i le.,psimelhpme(jl=1.
4 Iflpstljyl.ge.pstt.,and.pst(j)l,le.pst2)hpt2tj lel,
c..,., calculate vacuum b field (bvac) and derivatives dbv/dz, débv/dz2

asq= .25/1(2,.4rp)¥8(2,/3,)-1, Ie z2-z21) 42
bvO=bm*¥(1./(1,.¢(20-21)882/asq) at 5¢1./11.¢(20-221482/asq)
c¥e1 5)

do 5 i=l,ix

ebl=(zltl-z1l)/asq

eb2=(zlil-z2)/asq
fbl=saqrt(1,¢ebtel(z(il-z1)i
fb2=sart(1.¢eb2e(ziil-z2))
argt=¢(zli)-ztran)/ltran
dbvdzlil=-3tbm¥lebi/fble«Sreb2e/fb2a*e5)-beent ,54(1.-
¢ tanhlargt!##2)/i tran
d2bvdz2(1)=-34bmel(1./lasqtfblet5le), /lasqtfb2ee5)-eb1#4245/

cfb1#*7-eb2ee2e5/fo2ee7l+ebcenttanhlargt)#(1.-tanhlargt)s#2)/
c ltrane#2

5 bvacl(i)=bme(1./fb1##3¢1 ,/fb2ee3)+bcen®. 58(1,.-tanhlargt!)
argt3=(z3-ztran)/itran
bv3=bmel(1./(1.¢lz3-z21)%82/asqi tel .5¢1.7(1.+(23-z22)4#2/asq)
c¥eT Shebcent. 54(1.-tanhlargt3) )
rp3=bv3/l+¢bv0)
bmi=rpt#( bv)
alsit=((1.-1./rp1#¥2)/7(1.-1./rpxt¥2) #lrpl/rpx) lea]
alsizalsit+ 5#(1.-alsitl4#pfudge

c.,.,. Galculate heaveside function h56(i) for second component of
C...++ sloshing pperp

do 10 t=1,i«

eb2=(zlilezel/asaq

TFlz(il.gt.zliand.zlil,lt.z2.and.omi.ge,bvaclil)
e h56(i lel,
10 continue
C..s,. calculate pressure coeff. inctuding electron ring (pr)

conl=1./((1.-1./rpxee2) ee oabmaxetd )
con2=contt(-2tbmaxtt2)

cons=- Stcon2tbmaxte2
con4tpring/((1,-1,/rp3e82) ee 2sby3te4)
con5=con4t(-2abv3Ka2)

con6=- .StconStbv 3st?
donlet./(lt.-1, /rptea2)| aeetbm) ead)
don2sdonit(-2tbmi*e2)

don3=- .Stdon2tbomist2

c.,.., calculate constants for 63 pressure componetnt

data p30/,01/

we2=pewidet® ,5tpsid

woce=plewidet® Stpside

weS=ape/psim

psliOr=psid/psim

p3b=p30
p3c=(,58(1,-(tanh(2,))*#2)/wp3-p3btpewidet(2,-p2wide))
c *.5/p2wide
p3d=-(p3be2.tp3ctgpsiOr 1/13. epsiOr eee)
p3a=-(p3btpslOrep3ctpsidrttscep3dtpsiO0ret3)

c...,, calculate constants for pel
g2p=-.58(1,.-(tanh(-2,) 1442) /upde
g2f=,5€(1.-tanhl-2,.))
ael=p210

cel=psimetg2p-gefrael
bel=2,«(g2f-aell-psimetg2p
Cheese readjust peak plug pressure for sloshing

rtemp=(bm1i/bmax)] #2

rpxi2=1./rpxta2

tert=l(rtemp-rpxi2)#t2

ter 2=(1,-rpxi2) 42
bstrd=bmaxte2e(-terlealsitrtemptter2)/(-terlealsi*tter2)
pfloat=((cani-donttalsi)#tbstr2et2¢(con2-don2talsiltbstr2
c #¢con3-don3¥alsi)*tlt,+p3a)
pslosh=psloshin/pf loat
psltoshe=psloshen/pfloat
nslosh=nsloshin/pficat
psist=pslosh¢psloshe
pceenl=pcentertpcentee

do 6 t=1,1x

eonlt=conti-dontt¥alsi*h56(i)
eon2=cond-don2dtalisi th56(i)
eon3=con3-don3talsikh56(i)
abf(tl=con4*th34( i)

bbflil=conSeh34ali)

cbf lil=con6#h34(i)

abplil=eont¥lpsist#hl2lilepcentahilil)
bbplil=eon24l(psilstthl2lilepcent#hi lid)
chp{il=eon3#lpasistthi2lilepcenteht (id)

abrilt)=eont#tinsloshthi2lilencenterthi lid)
bbr(i)=eon2*(nstoshthl2(1lencenter#hi(i))
chr lil=eon3# nsloshthti2lilencenterthi(i))
abqlil=eont#(psloshtht2lil+epcenterthil(i))
boqlil=eon2tl(psloshthi2lilepcenterthifi))
6 ebqlil=eon3*(psloshtht2(i)lepcenterthi(i))
via CONStants for ering pperplb! long-thin
tf (long.eq.O)lgo to 21
bstr=bmaxtfring
faccb=1,/(bmaxt#2-bstrta2) ana
do 70 t=1,tx
tf lbvac(t).ge.bstri then
abflil=-pringtfaccbtht2(i)
bbf ll l=2. tor ingtfaccbhb#hi2(i)l*bstret2
cbhflil=pringtbmax# #24 (bmaxk#2-2 tbstree2) tfaccbshi2i( 1)
else
cbf ltl=pringtht2(7)
bbf(i)=0,
abf(i}=s0,
end if
20 continue
21 continue
return
end
subroutine equil tn
..equiltbrium far tandem mirror electron ring plug

.... insert storage cliches here
use peéram
use const
usé fstor

data epsb/1.e-2/, p30/.01/
Lee loop 10, calculate p2 pl and b and dp2/dpsi and dpi/dpsi
we2=pewidet .Stpsid
psibar=-bel®,5/cel
pimax=aelebeltpsibareceltpsioars#2

do 10 j=1,Jx

psirz=psilj)/psim

psire=psiljl/psime
pel=(ael+bel#tpsiretceltpsirestt2) tnpme (lj)
pe2=,5"(1,-tanhllpsilj)l-psidel/wp2e))4(1.-hpmelj)}
pllj)=(pel+pe2)/pimax

dpidpsil(j)l=(bele2.tceltpsirel/(psimetpimax] thpmel(j)-,.5#11,-(tanh
c ((psiljl-psiOe)/up2e) #82) /lwp2etpimaxlt( i, -hpme(j))
petijl=(t.-tanhl(psiljl-psiO)/wp2))#.5
dpZdpst(j)=e-.58(1.-(tanhl(psilj)-psi0)/wp2))8*2)/ape2
p3ljl=(p3a+p3btpsirt+p3ctpsirtecepsdtpsir tes) thpdlj }
dpSdpsiltl=(p3be2.tp3ctpsir +3 tp3dipsirts2ithpOljli/psin

peljl=petlj)lep3lj)
dp2dpsiljl=dpedpst(jl+dp3dpsi(ji

..... S@t p2 and p3 constant at large psi
if (p2(j).le.p2flag) then
peljl=p2tloor

11

50
51
10

do 11

end if

ulz=p2lj)®abplilept(j) )eabfli)
uzg=p2lj )*bbplti« Sept(jlebbfli)
tis-u2* .5/u1
ussp2lj)l*cbplil-bvacli)#e29 Sepiljlscbf ili)
radic=saqrt(tle#2-u3/ul)
bsqglstlé¢radic

bsq2=tl-radic

bsq=bsql
if(tl.gt.radiclbsqz=bsq2

bli, jlesartlbsq!)

continue

go to 10

b=bvac If pe.lt.epsp

do 51 t=, tx

bli, jlebvacti)

continue

. loop 15, calculate phi, the electric potential
do 15 t=1,1x
argl=((zlil-z1i/lz1-20) ) #8280 (-xpotlalti.-ht(il)
arg2=wpote((z2(il-z0)1/(z0-z22) 14882
phill(tl=phicetexplargtl+phipl/coshlarg2)

do 16 jz2,jx
phi2(pl=(1.-(psiljp l#he3ljy l/psislerypot)thp3ily)
continue

.. loop 20, calculate pperp, ppar and db/dpsi

pet=l./(ti-t./rpiee2) ate
dtert=(-8./3-4,#(bmax/bm11#"3/3.+4.8lbmax/bml}) bm!)
dter2=-alsitppttdteriltps!s]

do 20 i=1,1tx

do 20 j=1,j~

b2=bl(i,j)e#2

b4=b20e2

dter3=dter2eh56li)
dter=(4,tabpliltbmaxt#®2/3.¢2, tbbp lil) tbmaxedter3
ppart=(-abpli)/3.#bdé-bbplilseb2ecbpl(iledter*bli,jg))
ppert=l(abpliltbd+bbpl(ileb2ecbpli))
pperte=labqli)tbdéebbal i) *b2+¢cbhqlil)
pperpli,jl=p2ljltppert

pparli,j)=p2(jileppart

qubli,jl= (b2epparli,ji-pperpli,j))/bli,j)
rholi,jlzamasstlp2(j lee 5elabrliltbdebbr li ltb2ecbrl il de
c ncentertcold)

fac=bli,plettie2. eptlplel2.eabflilto2ebbf (ili)
facl=dpidpsilj)etabflilebAaebbflilsb2ecbf (it)
fac2=dpadpsiljl*labplil*baebbplil*b2+ecbplil!
fac3=p2l(jlel2,fabpliltb2ebbplillepi(jlel2.eabflilsb2<«bbFli))
dbdpsili,jle-(factefac2i/(bli,jlea(l.+fac3#2.))
dp2db=blit,j)#labpl(il*b2t2.+bbplille2.
dpedbe=bli.j)*labqliltb2e2.¢bbqlilise,

dp3db=dp2db-4,*abpliltbli.jle«3/3.-2.%bbplilebti.j)

c ¢dter

qubv(i,jl=(-dp2dpsiljl*(ppert+ppart)-p2tj ltdp3dbtdbapsili.J))
pharg=psi lj) *hp3lj)
dphidpsi=philliltypots(pharg/psi3isel(ypot-1,)/

¢ (-psi3)thp3lj)

epeilt,jl=-dphidpsi
dpdpsi=ppertetdp2dpsiljlep2lj ltdp2dbetdbdpsi li, J!
omegclzechargtbli.,j)/lamasstcee])

omegstrz-bli,j)#dpdpsi/omege!
omeggb=ppertetp2(jltdbdpsi{(i.J)/omegci
omegexb=-rholi,j )#ceetdphidpsi#.5
xxx lt, p)=lomeggb-omegstre+2, tomegexbltsf6
yyylt.j)=lomegexbtomeggb!) tlomegexb-omegstrlesf8B
ppectr=labflilebdaebbf (i lek2eebftit))
pperpsl(i,jlepperpli,jie¢pilj )*ppertr
pperpelit.jl=plljl*ppertr

20 continue

Coca check for negative frassure, and terminate preb. if necessary

do 25 jzl,jx
do 25 i=i tx
ifl(pperpli,jl. it. Q.or.pperpeli jl. it,.0,) then
write(S9,101)

101 formatl problem terminated due to negative pressure’ })
call exit(1)
end if

25 continue

c..,.calculate diagnostic on perpendicular pressure balance
do 8O i=T,ix
do 80 j=i,jx
errprplt jlslblt,pJlet2-bvaclil*#2¢2 tpperpsli,jli/bvactli)#*#2
80 continue
c...,calculate diagnostic on parallel pressure balance
do 81 j=2.jx
do 81 i=2,tx-1
delb=bli+¢1,jl-bli-1,j)
iflabs(delb).lt.epsbithen
abar=-abp(11*5,/3,
bbar=-3.*bbp(i)
dter3=dter2*h56(i)
dter4=(4.tabpl i) *bmax#*2/3.+2,.%*bbpl i) i *bmaxt+dter3
dbar=dter4*2.
factor=-l(abartebli,j)**4+bbartb(t J) **k2+cbe(il+dbartb(i jd)
else
factor=(pparli+1,jl*bli+l,jl-pparli-1,j)*#b(i-1,j))
c /delb
end if
81 errpril(i-1,j-1)=(pperpli,j)-2.¥*pparli,jl+factor)/bvacli)**2*2

Coes cal, r and r2z7¥r
do 40 i=1l,ix
sum1=0,
sum2=0
sum3=0,
sum4=0.
sum5=0.

do AO j=2,jx
dps=dpsi(j)

PAGE 1

psibepsi(j-1)
if lj} ,eq,elthen
desepst (2)
psibsQ,
end If
If lt gt, algo to 3
call beast (hpkO( 1)
call beast(hpki2t
call beast lhpkm(1)
call beast (hpkme( |
do 29 kel,kin
psiketpsibedpsk(k-11/(
iflpatkh It. psiQihpkol
Iflpstk lt .pstimihpkal
Iflpstk it .psimelhpkme
If (psik, lt pst2.and.ps
29 continue
Creves COL, pl (plik) at Intermediate points tn dps! tnterval
do 30 k=l,kin
paikspsibedpskl( ke 1) /ikhine1]
psikrsapsik/psim
pstkrespsik/psime
pleks(aelt+bel¥pstkretceltpsikretk2l thpkmelk)
pdaek= 5t(1,-tanhl(pstk-pstQel/we2e))*(1,-hpkne (a) )
elkik, Jl=(plek+peek ) /p imax
pak=(p3atp3b¥psikr+pse tps kr ee2¢p3d¥psikre¥3) RhOkOlk)
pek(k,Jlel(t.<tanhllpsik-pstOl/wp2l1)*,5 +p3k
30 continue
31 continue
do 32 k#1,kIn
if lp2k(kKi J). le, paflag) then
p2k(k,J)l=p2foor
pik(k,J)epifloor

O,,kIn)
,,0,,ktn)
0, ktn]
),O,,ktn]

k
k
k

1,
t.pslitlhpkta(kiet,

end If

iF ((p2k(k, fl), le,epsp.or,abpli},eq,0)} then
bkhebvac( i)

else

ul=p2k(k,J)*abp(t)+e1 ,p)*ab rH)
u2=p2kik, J )*bbpl(t)+pt ip lebbf(tl+,5

tl=-u2*,5/ul
US=p2k(k, J l&cbplti+pl
radicesagrt(t1**2-u3/u
bsql=titradic
bsq2=ti-radic
bsq=bsql

if ltl,gt,radiclbsqebsq2
bk=saqrtibsq)

—x Te

end if
capfet +2, ¥ptkh(k, J )#(2, #abf (1) ebkee2ebbf (i) 142, ¥p2kik, jp )*
¢ (2, kabpli | kbke*2+bbp (1) |
delil(kl=1,/bk
deli2(k) 1.7 (bk ek3kcapf |
deli3(k. sel 12(k)/(capfxbk #42)
delid(kl=eptk(k, ji lcapftbk | **3
deliS5(k)=p2k(k,ji/(capf*bk | **3
32 continue
call stmps(delil,deapti,kin,dps]
call simps(deli2,dceapi2,kin,dps]
call simpsldeli3,dcapt3,kin,dps)
c call simps(deli4,dcapi4,kin,dps)

PAGE

call stmpsldeltS,dcapiS.,kin,dps!

capltl=dcapil+sumt

capl2=deapi2+sum2

capl3=dceap!3¢sund

capid4=deapld+sumd4

cap lSzdceapi5+¢sum5

r(t,plesartl2,*eapit)

vv telbvacl() )¥dbvdzii))#**2

vvesbvacl(i bedebvdz2(tledbvdz(t)**2

r2z(l,Jleevvlteapt2ena/e (i,j) e343, avy)

e -vv2¥eapl2a/r li, jl+B. sbvac( i) #*2klabf it

¢ captS)/rili,j)

suml=¢capi

sum2tcapi2

sum3scapi3

sumAecap!4

sum5=capti5
40 continue
Cree, 8et ri, tler(t,2)

do 41 tal tx
4) reli, l)srli,2)

v
2
|
1

c calculate didagnosite quantities flutel,

do 60 jr2,jx-1

isz2

if (mod(ix-2,2),eq,0)is=3
do 61 {t#is,ix-1f
lazl-isel

Keapt3/rli,j)
}¥captid+rabplil*

flute2 and flute3

eterm=dpedpsil(ji*tlabplilebli,j laed4ebbp l(t lebli, J )aeeechpli))
c +p2lj) el Akabpl i )abl i,j )aK342kbbpli)abl1, 4p) )#dbdpsi lt, J)
ringjzdpidpsilj)¥*labflil*bli, jp eedebbe lt lett, pl aeZech Olid)
¢ epllp)e(Akabe li) Eb(T, | 1 ee 342Qebb F(T) eI TF) )tdbdpst (i,j)
dflutel(tal=¢r2z(i,plequbvds pile (i, piebli,y)e42)Zuuz(t)

c tetermtringj/bli,j)*83/uuz (i |
dflute2(ial=yyyli,gi7( lr di plebliiy)
c )#e2eb(i,jp))/uuz(1)

dflute3t(tal=rholi,j)/ Teg) ebCt pid ee2eb lt J) i fZuuzt(t)
dflutedlialz=xxxli,j)/ Pj) bli, pblee2abli jp )i/uuzti)
61 continue
call simps(dflutet,anst,ia,dus

call simps(dflute2,ans2,ia,du)

call simps(dflute3,ans3,ita,dul

call simps(dflute4d,ans4,ta,dul
flutel(jleanst*(ia-1)
flute2(jl=(ans2h(mmae2-1)+ansi)eiia-1)
flute3(j)=-ansl/ans3
rhoave(j)=ans3*lia-1)
xxxave(j)=ans4e(ia-1)
yyyaveljl=ans2*e(ja-1)

60 continue

grow=0,
growmax=0,
do 62 j=2,jx-1
if(flute3(j).gt.O)lgrow=grow+fluted3(j)
growmax=tamaxl(growmax,flute3(j))

62 continue
write(59, 102) grow, growmax

102 format l('grow=' ,e14.6,3x, 'growmax=',e14,6)

do 70 j=2,jx-1

c..... local growth rate for high mm, (whb approx, }

PAGE 3

omegwkb=mmn*  Stxxxavelf)l/rhoavel |)

trad= ,25¢mmee2a(xxxavelj)#*2+4, trhoaveljl*yyyave(j))
e -rhoavel(j)/**2ef lute3lj )

if(trad,le,O,)then

gamwkb(j)=saqrt(-trad)/rhoave(j)

omegiwkb{j l=omegwkb
omegewkb(j}=0,
else
omegiwkb(j }=omegwkb ¢saqrtitrad)/rhoave(] |
omegewkb(j)=omegwkb-sart(ltrad)/rhoave(})
end if
70 continue

return
end
subroutine simpsi(fin,fout,knn,df)

Cisse, Simpsons ruie quadratures, knn must be odd

dimension fin(1)

nse=(knan-1)/2

se=ssuminse,fin(2),2)

nso=nse~|

so=ssuminso,fin(3),2)

foutsdf/(3, elkan-T) el fini tiefintiknn) +4, #6e+2, #40)
return

end

subroutine equilcur

e,,,,equitltbrium for curvature driven flute mode case,

c...,insert storage cliches here,
use param
use const
use fstor

do 10 t=1l,ix
do 10 jH1,jx
C..,+. Special bli,j) to test b,c, on flute test case

bli,j)=bO
r(i,plesaqrt(2epsiljy)/bli,g))
rholt,jlalenO-enter(i,j)*#2*,5) *amass
xxe(t,plerholi,j)*€&lomegl+omege) *sf6
yyylt,jlerholt,j)#l-omegt*ameg2)*sf8
qubl(i,jl=b(t,j)
qvlt,jl=pO0/pstljx)

10 continue
return
end

subroutine equi

C.i,ees Spectal case equiltbrium, O beta, 0 pressure, rho=const,
C.,.., test case |

c..,,.set up 1/4/82 by r. freis

C...,,insert cliche storage here

use param
use matrix
uge const
use fstor

data rhoO/1.e12/,b0/1.e4/ ,azm/1./,apsim/1./

PAGE

10

Ce ete
Ce eae

30

ee

54
>
oO

Cc

tle, tabs(psilj}))/b0)

pYFpoa Ons 4H

Coo
oO-

return
end
subroutine equilrot

sets up equilibrium for rigid rotor, test Vise 2 ,
.flora3 adds cold plasma halo to equilbrutm density

insert cliche storage here
use param
use const
use fstor

psi0=bO¥*rOsgt 5S/sart(fourpt )
omegr=ratrodtomegst#(1,-enbar/enO)
foursq=sart(fourpt|

do 5 i=l,tx
uz=uuz(i}
do 5 j=#1,J™

faczexplipsi(jl/psit0)/sart(betad)

b(t, jJlebOtsaqrt(facke2-1,)/7(factfoursaq)
rholi,j)l=enOtamass/(betaQ*efact#2) tenbartamasse
betazl/factree

argl=fact+sart(fac¥#2-1, }

acosh=aloglargl)

rlt,jlerOesartl-crt+acosh!)
gub(t,jleb(i,j)
omegstr=omegst*(1,-enbartamass/rho. ,J)]
entestz=enbar tamass
iflentest,ge.rholi,j}lomegstr=0,
omegexb=(1.,¢ratrod)*omegstr
omeggb=+betatomegstr#,5/(1,-beta)

xxxli, Jlerhol(t, J l#l2, #omegexbtomeggb-omegst )
yyylt,jle-rholt,j)#lomegexbtomeggb!*lomegexb-omegst |
mex td, plexxx i,j )eftir
yyyli,jleyyylt,jplafie
continue
do 30 t#1,i«
do 30 j#2,jx-1
qavlt,jl=,5elqubli,jel)abli,jet)-qubli,j-1)*bls,j-1))
continue
return
end
subroutine initial

set up initial displacement vectors, xro and xio
test case 1, cosi(kz) in z, flat in psi
set up 1/4/82 by r. freis

insert cliche storage here
use param

PAGE 5

use fstor
use matrix
use const

data p1/3,1415926/

if(kzs,eq,
rbf=i,/(rl
else
rleranf (bl)
r2=ranf (bi)
r3eranflbl)
r4=ranfi(lb1}
endif

5 continue
kKtetele(j-2)elix-2)
kK2=p-1e(Jx-2)e(t-2)
k=, Se(1etswltkh1¢ St(t-iswl tke
xrolk )=exOtrbfe(rler2-1,)texttcos! Spi #(z |
xtol(k )=exOtrbfe(r3erd-1,leexttcosl Saptiaz(t

¢ xtolkl=cos(thetad) *xro(k]

10 continue
do 20 j#2,jx-1
ri=ranf (bl)
r2=ranf (bt)
r3eranf(b1)
r4=ranfibt)
do 20 t=2,ix-1
tfikzs,eq.O0} then
rof=t f(r (i, jlebli,jgll
else
rleranf (bl)
r2=ranf (bl)
r3=ranfibl)
rA=ranf(b1)
endif

15 continue
Klei-te(j-2)alix-2)
kK2=j-1eljx-2)e(i-2)
= SOK(Teiswltht+ 58#(1-iswl tke
xroolkl=exOerbfel(rl+r2-1,)leexttcos( Stpit(z(ill/zedge)
xioolk)=exOtrbfel(r3+r 4-1, leexitcos( Stpixztil/zedge)

¢ xtool(kl=cos(theta0)*xroolk)

20 continue
return
end

/zedge!}
e

1))
}/zedge)

subroutine input
c....,insert storage cliches here

use param

use const

use fstor

PAGE 6

Ciree, boundary conditions are set as follows;
Crease at z=z0 (i=l), file-1, Implies x=0,
Cheney fil=1, tmplies slope=0,
Cea at zezmax (izixd, flzx=-1, implies x=0
Chea fize=l. implies slope=0,
Core at psizepsiO (j=il, fptert, tmplies «#0,
Chevy fjlsi, implies slope=0,
Chee at psiztmax (jzjx)l, fjrxe-l, implies x«=0,
Chae ae fijrxsl, tmplies sltope=0,
data mm/4/, btas/.5/ |max/2/, nmax/5/,dv/1./, du/1./
e ,ndiag/100/, FIIZI 7, fFi2ax/1 J. FJV/I A fires PI 1s
c ,sf6/1,7, sfB/1,.7, kplotm/0/, kzs/1/, swgal/1./, swa2/1,/
¢ , swg3/1,/, swg4/1,/
Ci.rerforced data loaded for testing fourier analyses and zed file
Cisse maker
data jfour/1/,nfourp/1/,nfourmax/5/
namelist/nowl/aname,mm, bias, Imax, nmax,ndiag
c ,ftl,ftzx,fjl.firx exO,exl,fpsi,fu,fy, fz
c ,Kplotm,kzs,.jfour.nfourp.nfourmax,sf6.sf8,swgl,swga2.swg3,swgA4
call ddi({nowl,2,3,1)
if(notd,ne.tleall ddolnowt,100,0,1)
jxejrx
Kxx=kxp
tex =i zx
return
end
subroutine grid
Crs... relates physical grid z.psi to computational grid u,v lequally
c..,,. spaced }, uses input fpsi, fv, fz. fu and azm, apsim
c¢.,..,tnsert cliche storage here

use param
use const

xvealoglfpsil/aloglfv)
xu=aloglfz)/aloglful
zzp=0,
psip=0.,
do 5 t=#1,1tx

5 ult )suO¢dueli-1,5)
ult}s-ull)
azm=zulix)*eel(1,-xu)
do 10 tz1,tx
uuzlilsuli leet ,-xul/(xusazm)
zlijsazgm*ult)#*xu

uuzh(i)d=l(ulti«+,5#dul**(1,-xul/lxutazm)
dz(il=zlil-zzp
zzp=z(i)
10 continue
zedge=azm* 5#(uliv)*#xutulix-1)*#xu)
do 15 j=1,jx
v(jlevOe(j-1.5)4%dv
15 continue
vitle-v(1)
apsim=v( jx) eel 1,-xv]

PAGE

do 20 j=l,Jx
vpsi(jlevijlealt.-xvl/lapsimaxy!
vpsth(jle(vljpl¢ Sedv)eal(t -xvi/lapsimtxy)
psilplsapsimtyv(j ) eax

dpsit(jl=psilj)l-psip

psitp=psilj)

calculates the fl to f11 functions needed to generate the a and
uses the equilbrium quantities r, rho, b, etc,

f2t=(1, ~m2ltrholi,jl/bber2tvpe(rhali ,jell-rholi,j-tlhisle.tdv)

j)*e4ebbplilabli,plee2eebpli)}

dpedpsi=dpldpsiljl#labflileb(i,jleedebbflileb(t,j)ee2ecbflt))

jil/btli,gdl

on flute test case

20 continue
C,..., calculates v at plasma edge
vwelpsiw/apsim)ee( 1. /xv)
dvinelvaw-vijx-T)l/dv
dvout=elv(jx)-vwl/dv
return
end
subroutine fltol!
a ree
c, ' b matrices
C.sees Insert cliche storage here
use param
use fstor
use matrix
use const
mo=mmete
du2=dut*2
do 10 te#l,ix
do 10 j=2,jx
r2er(i, jie?
uz=uuz (i)
bb=b(i,j)
vp=vpsi(j)
rA=r2uno
fl Ci, jlerholt,j )*bbard
f2(1,p)=f2t/vp
F301, J lemmexxxli,j ber debb
FACT fletll.-m2) €mmexxe (i,j) 7bb
f5lt fle-matyyyli,j)er4dtbb
F7(i,p)=(1 m2) #(-m2layyy lt, ji/(bbtvp)
gA4li,jl=qubli,j)er(i, plese
gsli,jler (i, jlebli,j)
g2li,jiequbli ,j)fte li, jlebli,j)ieee
dppdpst=dp2dpsilj)#labplileb(i,
c +p2lple(Atabplil*b( i,j )eea¢2abbplilebli.j) ledbdpsil i,j)
c tpllj)elAwabf(rieb li, pl esse2ebbt (i lebli, jl ledbdpsili,j)
gilli, jpl=e(mmeuuzli dl eeeer (i, je ler zzli.g)
ecXqubvli,jledppdpsitdpedpsitr (i,
gif, jlegtti, j)*%*swgl
g2(t, j1z9211,j 1 #se92
g3Sli,jl=eg3li,jJl*swg3
g4li, jlecdli jltewod
Coe aae special gl to test b.c.
c gilli, ple-Cmmtuuzli dl eeeer (i par li, pli bese
c c¥qvii,j)
10 continue
Cheese fill in edge values

do 20 i=l,i«x

PAGE 8

fli, lbe-f#11,2)

f2li,T=f2ti,2)

f3(t,T)=-f301,2)

f4(i,1)=f401,2)

f5l(r,1)=-f#5(1,2)

f7(i, T)sF7(1, 2)

g4li,tle-g4li,2)
20 continue

return

end

subroutine amat
ci..,, calculates the matrix coefficients for al, a2, a3, b1, be
Crsees In the equation al¥x (n+l) sa2exinl+asexi(n-Tie+bityinl+b2ayl(n-1) ,
C.i.... uses fl to F111 from subroutine fltoll and equilibrium quantities,

Cieye. Cliche storage here

use
use
use
use

param
fstor
matrix
const

data unit/s1,/

gam3=-gam2
dug=dutk2
dt2adt¥**x2
dv2=dvtt2
dvt=2,¥#dv
me=mm eee

jx =jrx

txelzx
do 10 t=2,tx-]
do 10 jF2,jx.-1
kKl=t-le(j-2)e(ix-2)
kK2zj-le(jxw-2lati-2)

=, 5e(it¢iswiltkhi+,5#(1-tswl#k2
r2=rl(i,j lene

vp=vpsilj |
uz=uuz (1)
bijmh=(bli,jlebli jri)ie.5
bijph=(bli,plebli,jelli#.5
bipljph=(bliel, jellebtiel, plie.s
biptjmh=l(blied,j-Tlebliet,j))*,5
bimljph=(bli-T,jellebli-?t,jd)4.5
bimiljmh=(b(i-1,j-tlebli-1,j))#.5
gAiphjph=(gdlist,jellegdli,jlegdli+t,jlegd

{ )* , 25¥%uuzh(
gAiphjmhalgdliel jr-llegAli,plegaliel, Jlegdl

(

(

} i
})8, 2858euuzh(i
pie, 25euuzh(i
) 1

g4imhjph=(gAli-l,jetleg4li, jlegdli-1,jieg4
}*#, 25¢uuzhl

gAimh}mh=(g4li-1,jrllegdli,gleg4li-1,j)+g4
gZiphje(g2lie¢1 jieg2li, j))8 Seuuzhli)
g2imhj=(ge2li-1T,jieg2ti, jp) )*.5¢uuzhli-t)
gsiphj=a(g3liel Jleg3li, jp lle S#uuzh(i)
g3imhje(gSli-t,pleg3li.plie Stuuzhti-1)

i )
i, }
ij )
1, }

flijph=(f1li,plef tli petd)* Sevpsih(j)
flijmh=(fFTCE Gerri, j-11)*  Stvpsih(j-1)

PAGE

60

fSijgphel(f(Str, pre" Sli, pel l i * Sevpsiht(y)
ASijgmha (FSi, jp lef S(t, pt)" S#vpsihblj-d)
If (J.,gt.2lgo to 60

flijmh=0,

fEijmh=O0,

continue

uzbare-uuzlt)er( i, pl /ldu2tdv2)

al(k 1)e-gamltbimijmhtgdimhjmhebtjmhtuzbartvpsithi(j-1)
ec Ar (tnt jr)

a2(k, 1)e-gam2sbimijmhtgdimhjmhtbijmhtuzbartvpsih(j-1)
e Eelt-T,5-1)

ast(k, 1)=-gam3tbimtjmhtgdimhj mhtbijmhtuzbartvesih(j-1)
e ¥r(t-T,j-i)

al(kh 2)=-flijmh/((dttdv) *#2)eqgamial fSijmh/dv2¢bijmhs*e2euzbar
c ¥vpsth(j-Tler (i, g-lielgdimhjmh+gdiphjmh))

a2lk 2)2-fFlijmh/((dttdv) #2} egamee(f5ijmh/dv2t+bijmh*et2tuzbar
c &vpsih(j-Tlar(t,j-lietlgdtimhjmh+g4iphjmh) )}

as(k 2Q)a-fFlipmh/ ((dtedv) ##2)+gam3e( FSi jmh/dvetbl jmhe*2euzbar
c ¥vpsthij- Tier i, j-lietgd4imhymheg4iphjmh)}

al(k, 3)=-gamitbipljmhtgdiphjmhtbijmhtuzbartvpsth(j-tlar(iel.j-1)
a2l(k ,3)=-gam2tbipijmhtgd4iphjmhtbijmhtuzbartvpsihl(j-Tieriiel,j-1)
a3tk, 3)=-gamatbiptimhtgd4iphjmhtbijmhtuzbartvpsih(j-ller (ied j-d)
al(k AlsgamTe((bimtimh*gdimhjmhtvpsihl(j-tlebigmh+tbimijph*gAimbj ph
c kvypsth (J) #bifph) *uzbartrli-1,Jlemmee2ebl i,j )*uzbars
c g2imhj¥g3lit-t,j)#dv2/vpsi(j))

a2(k Al=gamex((bimljmhagdimhjmhtvpsthl(j-1)ebijmhebimijphtg4imhjiph
c¢ *¥vpsth(j)l*bijoh) tuzbartr(i-1,jlemmee2eb( i,j leuzbar®

c g2imhj *g3li-1,j)*#dve/vpsil(j))

a3(k 4!=gam3el(bimijmhtgd4imhjmh*tvpsih(j-Tiebijmh+bimljph*gdimhjph
c *vpsth(jlebtjph)*uzbartrli-1,j)emmee2eb( i,j }tuzbars

e¢ g2imhj*g3li-1.j)¥*dv2/vpsilj))

alik Sl=((flijpheflijmh)/dv2-f2li,jli/dt2+gami4s(-( FSi jphefSijmh
ec Mdv2ef7 (i plegilt plal-bijmhse2e(gdimhjmhegd4iphjmh) tvpsih(j-1)
c ~bijphtter(gdimhjph+g4iphjph)tvpsih(j) lee l(t, j)*uzbar-

c mmee2tb (1, J) kuzbart(g2imhj+g2iphj )*g3l(i, jl edvesvpsi(j |)

aZ(k SI=((Flijpheflijmh)/dv2e-f2li, pli) /dt2+¢gam2el-(F5ijphef5ijmh
c M/dv2tf7(i jlegl li, jlel-bijmhes2nl(gdimhjmh+g4iphjmh)tvpsihi(j-1)
c -bijph*#2e(ghimhjph+g4iphjphl*tvpsih(j)ier(i,j )*uzbar-

c mm*¥#2b (i,j )#uzbark(g2imhjeg2iphj l#g3l(i,jledv2/vpsilj))

a3(k SI=((F1Tijpheflijmh)/dv2-f2i,j))/dt2+gam3e(-(f5ijphefSijmh
c I/dv2ef7li flegtli,jle(-bijmhtt2anlgdimhjmh+g4iphjmhi*tvpsihij-1)
c ~bijph**2t(gdimhjph+gdiphjphi*tvpsih(j)lerli,j )*uzbar-

c mm*ke2tb li, J i*tuzbart(g2imhjegZiphj )&eg3li,j)edve/vpsilj))

al(k 6)=gamikll(bipljmhtg4iphjmhtbijmhtvpsih(j-Tlebipljphtg4iphjph
¢ ¥bijph*vpsih(j))*uzbartr lied, j lemma 2eb (i,j )euzbart

c g2iphj¥g3liel, jf )*dv2/vpsils))

a2tk Gl=gam2ul(bipljmh*gdiphjmh*bijmh*vpsih(j-1)+bipljph*g4iphjph
c ¥bijphtvpsih(j))*uzbartr(iel, j lemme e2ebl i,j )euzbars

c g2iphj¥*g3li+¢1 jladve/vpsilj))

a3(k G)=gam3e(l(biptjmh¥gdiphjmhtbijmh*vpsih(j-ll+biptjph#g4iphjph
c &bhijph*vpsih(jl) *uzbarer (i+t,jlemmee2eb (i,j l*uzbart

c¢ g2iphj¥g3li¢t jledv2/vpsilj))

al(k,7l=gam1#(-bimljphtgdimhjph#btjpht*vpsihl(j l*uzbararli-1,jet))

PAGE 10

a2th, 7l=gam2e(-bimljphtgdimhjphtbijphtvasih( jl *uzbarer(i-t,jett)
a3lk, 7)egam3t(-bimljph*gdimhjphtbijphsvpsth(j }tuzbarer(i-t. jel) )
a1(k Bl=-FLijph/(dt2tdv2legamIelf5ijph/dvae(bijphe’ 2e(gdimhjph
c +g4iphjphi*tvpsth (j)er (i, jet) *uzbar))
a2tk BI=-FLIijph/ (dt2tdv2legamae(f5ijph/dv2¢lbijph*e«2elgdimhjph
c ¢g4iphjph)*vpsih(j lect i, jel) *uzbar) |
a3(k Bla -flijph/ (dt2edv2)egam3e(F5ijph/dv2¢l(bijphe#2e(gdimhjph
ce +g4iphjphl*vpsthljlerdi,j*l)*suzbar))
al(k FIl=gami*(-bipljphtgdiphiphtbijphtvpsih(j )*uzbarerliel, jet) )
a2th Y)=gam2e(-bipljphtg4iphjphtbijphtvpsth(j)*uzbarar(ie*el jet) )
3k Ylegam3el-bipljiph*gdiphjphebijphtvpsthtj leuzbarerlie*l, jot)
c,..,,601 array for rhs
f3tijmh=al(F3li,plef3li,j-1))*,Stvpsthij-1)
FSijphal(F3li plef3lt pervtle Sevpsthlj)
denom=1./(dve2)
bitk, T)=f3tjmbtdenom
b1(k, 3I=f3tjphtdenom
bi(k, 2)s-(f3tjmh+f3ijph-fFAll,jledv2/vpledenom
10 continue
Cry... Correct coeffictents on boundaries
sfilesignlunit, fil)
sfjl=stgnlunit,fj1)
sfjrxetsignlunit. fjrx)
sfizxesigniuntt,ftzx)
C..,,. Set corners to 0
k1lt=tx-2
kK1jsteCix-3letjx-2)
K1= Sel letiswltktie Sel(t-iswlekt]
facl=-1,
ifl(sfjlieq.liand,sfizx.eq,i}fact=erlix-1,2)%b(ix-1,2)/
c (rlix,2)eblix,2))
al(k1,Slsat(kt Slefact#eal(k1,3)
a2(k1,5)=a2(k1 , S)+fact#a2tk1, 3)
a3tk1 Si=za3stk! S)efact#a3(k1, 3)

at(k1,3)=0.
a2(k1,3)=0.
a3(k1,3)=0,
R2;stelix-2)aljx-3)
kK2jsjx.-2

k2= S5e(1eiswltkhete¢ Stti-isw) *h2j
fac3=-dveut/dvin
if(sfjrx.eq.J.and.sfil.eq. J) fac3=r(2,jx-Tl*bl2,jx-11/7
ec (rll ,jw-P)eb(t,jxw-1))
al{(k2 5S)=alt(k2,5)+fac3eat(k2, 7)
a2lk2, S)ea2l(k2 Slefac3ta2(k2,7)
as(k2,5)=a3(ke S)+fac3sa3(k2,7)

ai(k2,7)=0,
a2(k2,7)=0,
a3(k2,7)=0,
fac2=-1,

ifisfjl.eq.liand.sfil.eq.tlfac2=r (2,2) #bl(2,2)/lr (1,2) *b(1,2))

h¢
a1(1,5)2a1(1,5)¢fac2vat(1,1)
a2(1 5)2a2(1,Silefac2tazl1,1)
a3(1,5)=a3(1,5)¢fac2ta3(1,1)
ai(1,1)=0,
a2(1,1)=0.
a3(1,1)=0,

facd=-dvout/dvin
if(sfjrx.eq.l.and.sfizx.eqg,lifacherlix-1,jxw-T)ablix-1,jx-11/
ce (rlix,jx-Tleblix,jx-1))

PAGE

11

ab ot
w—

12
20

21

22

30

ai(kup Sleallkxp Silefacdtat(kxp,9)
adgikxp Sil=a2lkup Slefacdta2ikxp,9)
a3ikxp S)=asikxup Sltfacdsas(kxp,9)
alikxp, 9120,

a2l(kxp, 9) =0,

a3s(kxp,9)=0,

122

se 11 pe2.ju-

fisfil.eq.!. lett ts er (2, ,jlabl2,j)Zlr Cl,
cleltetpeaiaties ~2)
Re=J-letjx-2)ali-2)
k= Se(letswltkt¢ Sa(1-isw) tk2
do 11 m=2,8,3
all(k mizaltk milesfil¥altk m-1)
a2ik mi=aZik mlesfil*ta2(k -m-1)
a3(k mlsa3t(k mi¢sfileasik m-1)
continue
continue
petee4
do 12 je#2,jx-]

if(sfizx.,eq 1. isfizeer(ixn-1,jleblix-1,

KRizi-Tel(j-2)elix-2)
kK2zjprteljx-2)a(i-2)

k= 5@(Tetiswlekie¢ Sa(1-iswltka
do 12 m=2,8,3

altk ml=allk mlesfizx¥all(k met)
aZgik ml=a2ik mlesfizxea2lk mei)
ad(k m)sa3dl(k miesfizxtadik mel)
continue

continue

j

}

2)*(i-2)

Peht+ Geli-iswltke
3

continue

t=ixe-d
do 22 jJ=2,jx-]
kKi=t-le(jp-2) 8 ix-2)
K2=t-Teljx-2)e(i-2)

= Se(letswlekt+ Sel l-isw)tk2
do 22 m=3,9,3
aitt(k,m)=0,
a2lk,m)=0,
a3(k,m)=0,
continue

jze2
do 31 t=2,1t«-1
Ktsi-le(p-2)elix-2)
k2=jr-telju-2leli-2)
k= 5e(leiswltk1¢.58(1-iswltke
do 30 m=4,6
allk ,mi=alt(kK  m)esfjleal(k  m-3)
aZ2t{k ml=za2tk miesfjleaZ2(k ,m-3)
a3(k mi=a3(k miesfil*east(k ,m-3)

continue

p)eb( 1d)

Jie (Cte plebtix pd)

PAGE

te

31
32

34

35
40

Aa
45

47

48

+ ee we
e @ @ @ 2

eo 8 ee

re

bitk 2)=b1(k 2lesfjlebilik,1)
continue

continue

jejxct

tac5S=sfjir«x
ifisfjrx.eq.-llfacS=facStdvout/dvin
do 35 t=2,ix-1

kKlBi-le(j-2)elix-2)
kKeep-lel(jx-2leli-2)

R=, 5e(l+iswltki«¢ Sa(1-iswltk2

do 34 m=4,6

al(k mlsal(k mie¢facSeal(k me3)

aZik ml=actk miefacSsa2tk -m+3)

a3tk mlsa3stk mi¢facSta3(k me3)
continue

bilk 2l=bit(k 2lefacSebiik, 3)
continue

continue

je

do 45 ji=2,tx-1

Klet-le(j-2) ei x-2)
kK2=jfrle(px-2)ali-2)

k= 5h (letswltkie Stll-iswltk2

do 44 m=4,6

alik,m-3])
a2ik,m-3)
ag(k,m-3)
continue
b1{k,7}20,

continue

J=]x-1

do 48 i=2,ix-1
kKisi-le(p-2)4ix-2)
kK2efr-le(puw-2)e(1-2)

k= ,50(1+iswleki¢.58¢(1-1sw) #k2
do 47 m=4,6

att(k,m¢3)=0,

a3stk,m+3)=0.

a2ik,m+3}=0.

continue

bitk,S1=0,

continue

return

end

0,
0,
0.

Non OR

subroutine comatlabar ,nd]

.transforms the elements of the al(k.m) array into into the

elements of the compressed column matrix abar which will be
operated upon by banfac and bansol.

insert storage cliches here
use param
use fstor
use matrix
use const

dimension abar(kxp,1)

PAGE

13

10

Ti

Kex=kxp

len=ndtkxp

call beastlabar(1,1),.0.. len)

do 10 k=1,kxx

do 10 m=1,9
Ipl=me((m-1)1/3) 8 thbw-4)
Ipe=lemod(m-1,3) 8 ihbw-Tlelm-1173
lp=.5¢(Teiswitipts¢ Set t-iswlttp2
abar(k,Ipl=al(k ml

continue

return

end

subroutine right

calculates right hand side vector for both equations,
rhsllk}e2taatar(n)-a2txer(n-Tleblatdxitbiexitn-1)) . and
rhs2ik)e2¥a3sexil(n)-aeexiln-Tieble(xr (tl-xrlin-1))

Insert cliches for storage here
use param
use fstor
use matrix
use const

do 10 jF2,jx-1

do 10 {22,ix-1
kK1si-telj-2)e(ix-2)
K2=prleljx-2)eli-2)

k= Sel tetswltkt+ Sel l-iswl tke
t1=0,

t2=0,

t3=0,

t¢e1=6,

t+2=0,

tt3=0.,

co S me1,9

Ppetin-~2em-((m-11/3) 83
Jezjr-lelm-1)73
ifljp.eq.lior.jp.eq.Jrx.or,ip.eq.lior.ip.eq.izxlgo to 5
Kpl=ip-~telix-2)8ljp-2)
kKp2=jp-leljx-2)#lip-2)
kp=,5e(Teiswltkpl+¢ Se 1-tawltkp2
tl=tleaZi(k ,ml#xroolkp)
t2=t2ead(k mi exraolkp])
ttl=ttlva2(kh ml txioolkp!)
tt2=tt2ea3(k mi txiolkp)

cant inue i

do 6 mn=1,3 oe

Jq=j-2emn

If ljq.eq.t.or.jq.eq.jrxigo to 6
kKql=i-teliv-2)8(jq-2)
Kqg2=ja-teljx-2ieli-2)

kqg=. 58 (1+iswiltkale¢.5¢(1-iswltka2
tS=t3eb (kh mnlelxiollkql-xioolkaq))
tteS=tt3ebtik mn) #(xrol(kql-xrootka!) )
continue
chstik)=(2.¥t2-tlefaciet3)
rhs2(kK)=2.¥tt2-ttlefac2etts
continue

PALE

14

es bs ew ¢

aoa ee

110

a

return
nd
subroutine rightvec

calculates right hand side vector for both equations.
rhsl(k}=2ba2txr(n)-agtarin-Tlebietxitli-extinetl) . and
rhs2ik)s2tastxi(nl-a2gexi(n-lPleblelxr( ll-xr(n-1))

insert cliches for storage here
use param
use fstor
use matri.«
use const

call sscal{kxwx,0,,rhs1,1]

call sscallkxx,0.,rhs2,1)

do 100 m=1,9

mdel=(m-11/3

mism~ 1

kof fle-mdeltSemel(mdel <1) 81x

kof f2=(m-(lmdel+1)43-1) )ejurl-26ml¢7emdel

kof f=, 58 (leiswlthof fle. 5¢(l-iswiltkof f2

do 110 kK=1,kxx
rhsl{(klerhsi(k}42, €a3st(k -m) @xrolkekoff l-a2(k mltxroolktehoff)
rhs2(kKlerhs2l(kle2, #a3l(k  mlextol(kekoff )-a2tk mlextoolkekoff)
iflm.eq.2.of,m.eq.5.or.m.eq.8lgo to 119

go to 100

continue

do 120 k=1,kxx

mbar=m-1-(m/4) ¥2
rhsilklsrhsilki¢efactlebt(k mbar laelxtol(kekoffl-xioolk+koff}}
rhs2(klerhs2lki+fac2abi(k mbar lt (xroll(kekoff l-«roolk+koff) )
continue

return

end

subroutine rigitdcon

special constants needed for rigid rotor equilibrium,

storeage cliche here
use param
use const

input for rigid rotor
data echarg/4.8e-10/, en0/1.00e+12/, bO/1.e4/, amass/3, 34e-24/
cee/3.e10/, valfk/.4/, fourpi/12,56637/, pi/3.1415926/
, enbar/Q.el1/
namelist/rotor/b0,beta0,ratrod,valfk,enO,echarg,rO0,rwb,enbar
call ddilrotor,2,3,1)

carg=saqrt(1.-beta0)

rOsq=r0kk2

aasq=r0sq*{(1.-carg)/beta0
er=,.5*(alog(1.+carg)-alogl1.-carg))
aa=saqrtl(aasq)

rw=rwb*aa

val f=bO/(sart(fourpi*tenO*amass) | {
omegc i =echarg*bO/lamasstcee)

omegp2=fourpi *enO*echarg**2/amass
omegst=2,*betaD*omege i *cee**2/ | omegp2%r0sq)

