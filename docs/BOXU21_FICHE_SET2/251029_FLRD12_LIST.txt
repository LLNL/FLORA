Wy — — — os es

21

Cx*e*DATE WRITTEN

SUBROUTINE SGBCOIABD,LDA,N,ML,MU,IPVT,RCOND, 2)
C¥*x*BEGIN PROLOGUE SGBCO

780814 (YYMMOD |

Cx**REVISTON DATE 820801 (YYMMDO)

CxxxCATEGORY NO,

D2A2

Cee*KEYWORDS BANDED, CONDITION, FACTOR, LINEAR ALGEBRA, LINPACK, MATRIX
C¥x*AUTHOR MOLER, C, B,, (U, OF NEW MEXICO)

Cx**PURPOSE
C
C¥*xxDESCRIPTION

Factors & real BAND matrix by Gaussian elimination

and estimates the condition number of the matrix,

SBGCO factors a real band matrix by Gausstan
elimination and estimates the condition of the matrix,

On

RCOND

solve

compute
compute

Entry
ABD

LDA

ML

MU

Return

ABD

IPVT

1 DOND

Is mot needed, SGBFA Its slightly faster,

A¥X = B , follow SBGCO by SGBSL,

INVERSE(A)*C , follow SBGCO by SGBSL,
DETERMINANT(A) , follow SBGCO by SGBDI,

REAL(LOA, N)

contains the matrix In band storage, The columns

of the matrix are stored In the columns of ABD and
the diagonals of the matrix are stored In rows

ML+1 through 2*ML+MU+1 of ABD ,

See the comments below for detalls,

INTEGER
the leading dimension of the array ABD ,
LOA must be ,GE, 2*ML + MU + 1 ,

INTEGER
the order of the ortginal matrix,

INTEGER
number of diagonals below the main diagonal,
QO ,LE, ML ,LT. N,

INTEGER

number of dtagonals above the main diagonal,
O ,.LE, MU LT. N ,

More effictent tf ML ,LE, MU ,

an upper triangular matrix tn band storage and
the multtpliers which were used to obtain it,
The factorization can be written A = L*¥U) where
L ts a product of permutation and unit lower
triangular matrices and U ts upper triangular,

INTEGER(N)

an integer vector of pivot Indices,

REAL

an estimate of the reciprocal condition of A ,

For the system A*X = B , relative perturbations

in A and B of size EPSILON may cause

relative perturbations tn X of stze EPSILON/RCOND

If RCOND is so small that the logical expression
1,0 +. RCOND .EQ, 1,0

is true, then A may be singular to working

‘

me eee es ts os
RIAIAQIN— a a se es ee os ae sr

jomedt mmantb: ml amd
NO AIK
NOUN &

128

eloleleletolelelelelelelelsel el elelelelelslelelelelelelelelslelalctelrlelsteketelelelelelelsicleleteleleleleleleleleis:

precisten, In partteular, RCQND Is zero tf
exact singularity ts detected or the estimate
underflows,

REAL IN)

a work vector whose contents are usually unimportant,
If A ‘ts close to a singular matrix, then Z Is

an approximate null vector im the sense that
NORM(A¥*Z) = RCOND*NORMI(A)*NORM(Z) ,

Lae |

Band Storage

If A ts & band matrix, the following program segment

will set up the tnput,
ML = (band width below the diagonal)
MU = (band width above the diagonal)
M= ML + MU + 1
DO 20 J = 1, N
11 = MAXO(1, J-MU)
T2 = MINO(N, J+ML)
DO 10 I = 11, T2
K=I-J+M
ABD(K,J) = A(T, J)
10 CONTINUE
20 CONTINUE

Thts uses rows ML+1 through 2aML+MU+1 of ABD ,

In addition, the first ML rows in ABD are used for
elements generated during the triangularization,

The total number of rows needed tn ABD ts 2*ML4+MU+1 ,
The ML+MU by ML+MU upper left. triangle and the

ML by ML lower right triangle ara not referenced,

Example: If the ortginal matrix ts

1213 0 0 0
2223 24 0 0
32 33 34 35 O
0 43 44 45 46
Oo O 54 55 56
0 0 O 65 66

s9=—

Zz co00+-—

then ‘= 6, ML = 1, MU = 2, LDA ,GE, 5 and ABD should contain
* * + + + | * = not used
* 13 24 35 46 , + = used for pivoting

tk 12 23 34 45 56

11 22 33 44 55 66

21 32 43 54 65 x

+ 3

LINPACK. This verston dated 08/14/78 ,
Cleve Moler, University of New Mexico, Argonne National Lab,

Subroutines and Functions

LINPACK SGBFA

BLAS SAXPY,SDOT,SSCAL, SASUM

Fortran ABS,AMAX1,MAXO,MINO, SIGN

C¥*x*REFERENCES DONGARRA J.J,, BUNCH J.R,, MOLER C.B,, STEWART G.W,,
xLINPACK USERS GUIDE*, SIAM, 1979,

C###*ROUTINES CALLED SASUM,SAXPY,SDOT,SGBFA,SSCAL

C¥xxEND PROLOGUE SGBCO

INTEGER LDA,N,ML,MU, IPVT(1)

oO

ee ek ee ee ee es ae a a se se a a as a ns te ss

C
C
C
C

o

20

30

40

REAL ABO(LDA,1),2(1)
REAL RCOND

REAL SDOT,EK,T, WK, WKM
REAL ANORM,S,SASUM, SM, YNORM
INTEGER IS, INFO, J, JU,K,KB,KP1,L,LA,LM,LZ,M,MM

COMPUTE 1-NORN OF A

OXF TIRST EXECUTABLE STATEMENT \iGBCO

ANORM = 0,0E0

L ‘= ML + 1

IS = tL + MU

00 10 J=1, N
ANORM = AMAX1(ANORM, SASUM(L,ABD(IS,J),1))
IF (IS ,GT, ML + 1) IS IS - 1

IF (J .LE, MU) L = bot
TF (J iGE, N- ML) Cet -4
CONTINUE
FACTOR

CALL SGBFA(ABD,LDA,N,ML,MU,IPVT, INFO)

RCOND = 1/(NORM(A)*(ESTIMATE OF NORM(INVERSE(A)))) ,

ESTIMATE = NORM(Z)/NORM(Y) WHERE A¥*Z = Y AND TRANS(AI¥Y = E ,
TRANS(A) IS THE TRANSPOSE OF A . THE COMPONENTS OF E ARE
CHOSEN TO CAUSE MAXIMUM LOCAL GROWTH IN THE ELEMENTS OF W WHERE
eeNelow = E , THE VECTORS ARE FREQUENTLY RESCALED TO AVOID
OVERFLOW,

SOLVE TRANS(U)¥W = E

EK = 1,0E0

DO 20 J = 1,
Z(J) = 0,0

CONTINUE

M= ML + MU + 1

JU = 0

DO 100 K = 1, N

N
EO

IF (Z(K) ,NE, 0.0EO) EK = SIGNIEK,-Z(K))

IF (ABS(EK-Z(K}) ,LE, ABS(ABDIM,K))) GO TO 30
S = ABS(ABDI(M, K)) /ABS(EK-2(K1} |
CALL SSCALIN,S,Z,1)
EK = S*EK

CONTINUE

WK = EK - Z(K])
WKM = -EK - Z(K)
S = ABS(WK}
SM = ABS(WKM) -
IF (ABD(M,K) ,EQ@, 0.0E0) GO To 40
WK = WK/ABD(M, KI
WKM = WKM/ABDIM,K}
GO TO 50
CONTINUE
WK = 1,0E0
WKM = 1,0E0
CONTINUE
KP1 = K +1
Ju = MINO(MAXO(JU,MU+IPVT(K)) NI
MM = M
IF (KP1 ,GT, JU) GO TO. 90
DO 60 J = KP1, JU
MM = MM - 1

231
232
233
234
235
236
237
238
239
240
24)
242
243
244
245
246
247
248
249
250
251
252
253
254
255
256

N0oN

OoM Oo

OOD

60

70
80
90

100

120

SM = SM + ABS(Z(J)+WKM*ABDIMM, J) |

Z(J) = 21d) + WK*ABDIMM, J)
S = S + ABSIZ(J))
CONTINUE
IF (S ,GE, SM} GO TO 80
T = WKM - WK
WK = WKM
MM = M
DO 70 J = KP1, JU
MM = MM - 1
Z(J) = Z(d) + TeABDIMM, J)
CONTINUE
CONTINUE
CONTINUE
Z(K) = WK
CONTINUE

S = 1,0E0/SASUMIN,Z,1)
CALL SSCALIN,S,Z,1)

SOLVE TRANS(L)*Y = W

D0 120 KB = 1, N
K=N +1 - KB
LM = MINO(ML,N-K)
IF (K .LT, N} Z(K) = 2(K} + SDOT(LM, ABD(M+1,K1,1,Z(K41),
IF (ABS(Z(K1) ,LE, 1,0£0) GO TO 110
S = 1,0E0/ABS(Z(K} |
CALL SSCALIN,S,2Z,1)
CONTINUE
L = IPVT(K)
T = ZL)
Z(L) = ZK)
Z(K) = T
CONTINUE
S = 1,0EO/SASUMIN,Z, 1]
CALL SSCALIN,S,Z,1]
YNORM = 1,0E0
SOLVE L¥V = Y
DO 140 K = 1, N
L = IPVT(K)
T = 2(L)
Z(L) = 2(K)
Z(K) = T
LM = MINO(ML,N-K)
IF (K .LT. N) CALL SAXPY(LM,T,ABD(M4#1,K),1,2(K#1), 11
IF (ABS(Z(K}) ,LE, 1,0E0) GO TO 130
S = 1,0EO/ABS(ZIK}}.
CALL SSCALIN,S,Z,1)
YNORM = S®YNORM
CONTINUE
CONTINUE

S = 1,0E0/SASUMIN,Z,1)
CALL SSCALIN,S,2Z,1)
YNORM = S*YNORM

SOLVE Ux*Z = W

00 160 KB = 1, N
K = N + 1 - KB

IF (ABS(Z(K)) .LE, ABS(ABDI(M

(K

K)))} GO TO 150
S = ABS(ABD(M, K})/ABS(Z }

)

1)

257
258
259
260
261
262
263
264
265
266
267
268
269
270
271
272
273
274
275
276

C

CALL

SSCALIN,S,2Z,1)

YNORM = S*YNORM
150 CONTINUE

IF (ABO(M,K) .NE, 0,0E€0)
IF (ABD(M,K) ,EQ, 0,0E0)
LM = MINO(K,M) - 4

LA = M - LM

LZ = K - LM

T = -2(K)

Z
Z

2(K)/ABD(M,K)

K }
K } 1,0E0

ot

CALL SAXPY(LM,T,ABDILA,K),1,2(12),1)

160 CONTINUE
MAKE ZNORM

= 1,0

> = 1,0E0/SASUMIN,Z,1)

CALL SSCAL

(N,S,2,1)

YNORM = S*YNORM

IF (ANORM
IF (ANORM
RETURN
END

WNE, 0,0E0) RCOND
,EQ, 0,060) RCOND

YNORM/ANORM
0,0E0

277 SUBROUTINE SGBOI(ABD,LOA,N,ML,MU,IPVT,DET)

278 C*#*xxBEGIN PROLOGUE SGBODI

279 Ce*XKDATE WRITTEN 780814 (YYMMODD)

280 C¥**REVISION DATE 820801 (YYMMDD)

281 Ce*xxCATEGORY NO, OD3A2

282 C##*KEYWORDS RAR eC NANT FACTOR, INVERSE LINEAR ALGEBRA ,LINPACK,
284 Ce*x*AUTHOR MOLER, C, B,, (U, OF NEW MEXICO)

285 Ce¥*x*PURPOSE Computes the determinant of a BAND matrix

286 C ustng the factors computed by SGBCO or SGBFA,

287 C If the tnverse is needed, use SGBSL N- times,
288 C¥ek*xDESCRIPTION

289 C ;

2390 C SGBDI computes the determinant of a band matrix

291 C using the factors computed by SBGCO or SGBFA,

292 C If the tnverse ts needed, use SGBSL N- times,

293 C

294 C On Entry

295 C ;

296 C ABD REAL(LDA, NI

297 C the output from SBGCO or SGBFA,

298 C

299 C LDA INTEGER ,

300 C the leading dimension of the array ABD ,
301 C

302 C N INTEGER

303 C the order of the ortginal matrix,

(304 C \

305 C ML INTEGER
306 C number of diagonals below the main diagonal.
307 C

308 C MU INTEGER

309 C number of diagonals above the main diagonal,
310 C

311 C IPVT INTEGER(N)

312 C the pivot vector from SBGCO or SGBFA,

313 C

314 C On Return

315 C .

316 C DET REAL (2)

317 C determinant of original matrix.

318 C Deter ninant = DET(1) * 10,0**DET(2)

319 C with 1,0 ,LE. ABS(DET(1)) .LT. 10,0

320 C or DET(1) = 0,0

321 C

322 C LINPACK, This version dated 08/14/78 .

323 C Cleve Moler, University of New Mexico, Argonne Nattonal Lab,
324 C

325 C Subroutines and Functions

326 C

327 C Fortran ABS

328 CKX*REFERENCES DONGARRA J.J., BUNCH J.R., MOLER C.B., STEWART G.W.,
329 C *LINPACK USERS GUIDE*, SIAM, 1979,

330 C***xROUTINES CALLED (NONE)

331 C*xxEND PROLOGUE SGBDI

332 INTEGER LOA,N,ML,MU,IPVT(1)
333 REAL ABD(LDA,1) ,DET(2)

334 C

335 REAL TEN

336 INTEGER I,M

337 C

338 Cex*FIRST EXECUTABLE STATEMENT SGBDI
339 M=ML + MU + 1

340
341
342
343
344
345
346
347
348
349
350
351
352
353
354
355
356
357
358
359
360
361

20
30

40
60

= -DET(1)

x rd
ry
—
oO
m
+
—>

a

om TT CO UT
AIX MNO vw Im

CONTINUE
IF (ABS(DET(1)) .LT, TEN) GO TO 49
DET(1) = DET(1)/TEN
DET(2) = DET(2) + 1,0E0
GO TO 30
CONTINUE
CONTINUE
CONTINUE
RETURN
END

362 SUBROUTINE SGBFA(ABD,LDA,N,ML,MU, IPVT, INFO)

363 Cx**xBEGIN PROLOGUE SGBFA

364 CeeaDATE WRITTEN 780814 (YYMMDD)

365 Ce**REVISION DATE 820801 (YYMMND)

366 C***CATEGORY NO, D2A2 .

367 Cee*KEYWORDS BANDED, FACTOR,LINEAR ALGEBRA,LINPACK, MATRIX
368 Cx*xxAUTHOR MOLER, C. B., (U, OF NEW MEXICO)

369 Cx*e*xPURPOSE Factors a real BAND matrix by elimination,
370 C***DESCRIPTION

371 C

372 C SGBFA factors a real band matrix by elimination,

373 C

374 C SGBFA ts usually called by SBGCO, but it can be called

37° Cc directly with a saving in time tf RCOND ts not needed,
376 C

377 C On Entry

378 C

379 C ABD REAL(LDA, N)

380 C contains the matrix itn band storage, The columns
381 C | of the matrix are stored in the columns of ABD and
382 C the diagonals of the matrix are stored tn rows
383 C ML+1 through 2*ML+MU+1 of ABD ,

384 C See the comments below for details.

385 C

386 C LDA INTEGER

387 C the leading dimension of the array ABD

388 C LDA must be ,GE., 2*ML + MU + 1 ,

389 C

390 C N INTEGER

391 C the order af the original matrix,

392 C .

393 C ML IN‘ EGER

394 C number of diagonals below the main diagonal.

395 C O .LE., ML .LT. NN,

396 C

397 C MU INTEGER

398 C number of diagonals above the main dtagonal,

399 C O .LE. MU LT. NN,

400 c More efficient if ML .LE, MU

401 C- On Return

A402 C

403 C ABD an upper triangular matrix tm band storage and
404 C the multipliers which were used to obtain it,
405 C The factorization can be written A = L*¥U , where
406 C L ts a product of permutation and unit lower
407 Cc triangular matrices and U its upper triangular.
408 C

409 Cc IPVT INTEGERI(N)

410 c an integer vector of pivot indices,

4iic

Ai2c INFO INTEGER

413 C ' = 0 normal value,

414 C = K if U(K,K) ,E€Q@,. 0.0 . This is not an error
415 C. condition for this subroutine, but it does
416 C indicate that SGBSL wil! divide by zero if
417 C called, Use RCOND in SBGCO for.a reliable
Aig C indication of singularity.

aig c

A20 C Band Storage

421 C

422 C If A is a band matrix, the following program segment
423 C will set up the input.

424 C

425 C ML = (band width below the diagonal)

426 C MU = (band width above the diagonal)

427 C Me ML + MU + 1

428 C DO 20 J =1, N

A429 Cc 11 = MAXO(1, J-MU)

A430 C T2 = MINO(N, J+ML}

431 C DO 10 I = 11, I2

432 C K=I-J+M
- 433 C ABD(K,J) = Ali,J)

A434 C 10 CONTINUE

435 C 20 CONTINUE

436 C

437 C This uses rows ML+1 through 2*ML+MU+1 of ABD .
438 C In addition, the first ML rows itn ABD are used for
439 C elements generated during the triangularization,

440 C The total mumber of rows needed in ABD ts 2*ML+MU+1
441i C¢ The ML+MU by ML*MU upper left triangle and the

442 C ML by ML) lower right triangle are not referenced,

443 C

AAA C LINPACK, This version dated 08/14/78

445 C Cleve Moler, University of New Mexico, Argonne National Lab,
446 C

447 C Subroutines and Functions

448 C

449 C BLAS SAXPY,SSCAL, ISAMAX

450 c Fortran MAXO,MINO

451 Cek*REFERENCES DONGARRA J.J,., BUNCH J.R,, MOLER C.B., STEWART G.W.,
452 C *LINPACK USERS GUIDE*, SIAM, 1979,

453 C*e**ROUTINES CALLED ISAMAX,SAXPY,SSCAL

454 Cx**END PROLOGUE SGBFA

455 INTEGER LDA,N,ML,MU, IPVT(1), INFO
456. REAL ABD(LDA,1) .

457 C

458 REAL T oe :

459 INTEGER I, ISAMAX,10,J, JU, JZ, JO,J1,K,KP1,L,LM,M,MM, M1
460 C 7

461 C¥X*FIRST EXECUTABLE STATEMENT SGBFA

Ab2 M= ML + MU + 1

463 INFO = 0

AbA C

A65 C ZERO INITIAL FILL-IN COLUMNS

466 C

AG7 JO = MU + 2

AGB J1 = MINO(N,M) - 14

469 IF (J1 .LT, JO} GO TO 30

470 DO 20 JZ = JO, JI

A471 10 =M+1- JZ

472 DO 10 I = 10, ML

473 ABD(I,JZ) = 0.0E0

A74 10 CONTINUE
475 20 CONTINUE
476 30 CONTINUE

477 JZ = JI
478 JU = 0

479 C°

480 C GAUSSIAN ELIMINATION WITH PARTIAL PIVOTING
481 C

A82 NM1 = N- 1

483 IF (NM1 .LT. 1) GO TO 130

ABA DO 120 K = 1, NMI

485 KP1 =K +1

ABE C

487 C ZERO NEXT FILL-IN COLUMN

A8B8 C

489 JZ = JZ + 3

490 IF (JZ .GT, N) GO TO 50
41 IF (ML .LT. 1) GO TO 50

492 DO 40 I = 1, ML

493 ABD(I,JZ) = 0,0E0

434 40 CONTINUE

495 50 CONTINUE

496 C

4397 C FIND L = PIVOT INDEX

498 C

499 LM = MINO(ML,N-K)

500 L = ISAMAX(LM+1,ABDIM,KI,1) + M- 1

501 IPVT(K] = L + K - M

502 C |

503 C ZERO PIVOT IMPLIES THIS COLUMN ALREADY TRIANGULARIZED
504 C

505 IF (ABDIL,K) .EQ@. 0.0E0) GO TO 100

506 C

507 C INTERCHANGE IF NECESSARY

508 C

509 IF (L .E@. 4) GO TO 60

510 T = ABD(L,K)

511 ' ABD(L,K} = ABDIM,K)

512 ABD(M,K) = T

513 60 CONTINUE

514 C

515 C COMPUTE MULTIPLIERS

516 C

517 T = -1,0E0/ABDIM,K)

518 CALL SSCAL(LM,T,ABD(M+1,K),1)

519 C

520 C ROW ELIMINATION WITH COLUMN INDEXING
521 C

522 JU = MINO(MAXO(JU,MU+IPVTIKI),NI

523 MM = M

524 IF (JU .LT. KP1) GO TO 90

525 DO 80 J = KP1, JU

526 L=L-1

527 MM = MM - 1

528 T = ABD(L, J!

529 IF (L .EQ. MM) GO TO 70

530 ALCL, J) = ABDIMM, J)

531 ABDIHM, J) = T

532 70 CONTINUE .
533 CALL SAXPY(LM,T,ABD(M+1,K),1,ABD(MM+#1,J), 1)
534 80 CONTINUE '
535 90 CONTINUE

536 GO TO 110

537 100 CONTINUE

538 INFO = K

539 110  . CONTINUE

540 120 CONTINUE

541 130 CONTINUE

542 IPVT(N) = N ,

543 IF (ABD(M,N) .EQ@. 0,0E0} INFO = N

BAA RETURN |

545 END

SUBROUTINE SGBSL(ABD,LDA,N,ML,MU, IPVT,&, JOB)

546

547 Cx*x*BEGIN PROLOGUE SGBSL

548 C*x*xxDATE WRITTEN 780814 (YYMMDD }

549 Ce**REVISION DATE 820801 (YYMMDD)

550 Cex*CATEGORY NO. OD2A2

551 Ce*e*xKEYWORDS BANDED,LINEAR ALGEBRA,LINPACK,MATRIX,SOLVE

552 Cex*x*AUTHOR MOLER, C. B., (U. OF NEW MEXICO)

553 Ce*x*PURPOSE Solves the real BAND system A*X=B or TRANSIA)*X=B
554 C using the factors computed by SGBCO or SGBFA.

555 C***DESCRIPTION

556 C

557 C SGBSL solves the real band system

558 C A * X = B or TRANS(A} * X = B

559 C using the factors computed by SBGCO or SGBFA.

560 C

561 C On Entry

562 C

563 C ABO REAL(LDA, N)

564 C the output from SBGCO or  SGBFA.

565 C

566 C LDA INTEGER

567 C the leading dimension of the array ABD

568 C

569 C N INTEGER

570 C the order of the original matrix,

571 C OS

572 C ML INTEGER

573 C ‘number of diagonals below the main diagonal.
574 C

575 C MU INTEGER

576 C - number of diagonals above the main diagonal.
577 C ;

578 C IPVT INTEGER(N) .

579 C the pivot vector from SBGCO or SGBFA.,

580 C

581 C B REAL (N)

582 C the right hand side vector.

583 C

584 C JOB INTEGER

585 C = 0 to solve Ax*X = 8B ,

586 C = nonzero to solve TRANS(A)*X = B , where
587 C TRANS(A) is the transpose,

588 C

589 C On Return

590 C

591 C B the solution vector X

592 C

593 C Error Condition

594 C

595 C A division by zero will occur if the input factor contains a
596 C zero on the diagonal. Technically, this tndicates singularity,
597 C but it its often caused by improper arguments or improper
598 C setting of LDA . It will not occur tf the subroutines are
599 C called correctly and if SBGCO has set RCOND .GT. 0.0
600 C or SGBFA has set INFO .EQ. 0

601 C

602 C To compute INVERSE(A) * C where C is a matrix

603 C with P columns

604 C CALL SBGCO(ABD,LDA,N,ML,MU,IPVT,RCOND, Z)

605 C If (RCOND is too smal!) GO TO .,.

606 C DO 10 J = 1, P

607 C CALL SGBSL (ABD, LOA,N,ML,MU,IPVT,C(1,J),0)

608 C 10 CONTINUE

609
610
611
612
613
614
615
616
617
618
619
620
621
622
623
624
625
626
627
628
629
630
631
632
633
634
635
636
637
638
639
640
641
642
643
644
645
646
647
648
649
650
651
652
653
654
655
656
657
658
659
660
661
662
663
664
665
666
667
668
669
670
671
672

LINPACK. This version dated 08/14/78

Subroutines and Functions

BLAS SAXPY ,SDOT
Fortran MINO

OOOAIOOaaAG

Ce¥x*kREFERENCES DONGARRA J.J., BUNCH J.R., MOLER C.B.,

oO

*LINPACK USERS GUIDE*, SIAM, 1979.
Cx*x*ROUTINES CALLED SAXPY,SDOT

Cx*#*END PROLOGUE SGBSL

INTEGER LOA,N,ML,MU,IPVT(1), JOB

REAL ABD(LDA,1),B(1)

REAL SDOT,T

INTEGER K,KB,L,LA,LB,LM,M,NM1
Cx*xFIRST EXECUTABLE STATEMENT SGBSL

M=MU + ML + 1

NM1 = N - 1

IF (JOB .NE. 0) GO TO 50

JOB = 0 , SOLVE A* X =8B
FIRST SOLVE L*Y = B

MOOD

IF (ML .EQ@. 0) GO TO 30
IF (NM? .LT, 1) GO TQ 30
DO 20 K 1, NMI
LM = NO(ML,N-K]
T(K)

M1
PV
(L)
Fe (L .EQ.

a

I
B
L K) GO TO 10
B(L) (K}
B(K)

10 CONTINUE

CALL SAXPY(LM,T,ABD(M+1,K),1,B(K+1),7)
20 CONTINUE

30 CUNTINUE

B
T

NOW SOLVE U*X = Y

oan

DO 40 KB = 1, N
K = N+ 1 - KB
BiK) = B(K)/ABDIM,K)
LM MINO(K,M) - 1
LA M - LM
LB K - LM
T = -B(K)
CALL SAXPY(LM,T,ABD(LA,K),1,B(LB),1)
40 CONTINUE
GO TO 100
50 CONTINUE

fy

JOB = NONZERO, SOLVE TRANS(A) * X = B
FIRST SOLVE TRANS(U)#Y = B

AIA

= 1,N
MINO(K,M) - 1
LA M- LM.
LB K - LM
T = SDOT(LM,ABD(LA,K},1,B(LB),1)}
B(K) = (B(K} - TI/ABDI(M,K)
60 CONTINUE

DO 60
LM

A

C

Cleve Molar, University of New Mexico, Argonne National Lab.

STEWART G.W.,

673 C
674 C
675
676
677
678
679
680
681 |
682
683
684
685
686
687
688
_ 689
690
691

70
80
90
100

NOW SOLVE TRANSI(LI#X = Y

IF (ML .EQ@. 0) GO TO 90
IF (NM1 .LT. 1) GO TO 90

END

DO 80 KB = 1, NMI
K = N - KB
LM = MINO(ML,N-K)
BiK) = B(K) + SDOT(LM, ABD(M+1,K),1,B(K4+1),1)
L = IPVT(K!
IF (L .E@, K) GO TO 70
T = BIL)
BiL) = Bik)
B(K) = T
CONTINUE
CONTINUE
_ CONTINUE
CONTINUE
RETURN

692
693
694
695
696
697
698
699
700
701
702
703
704
705
706
707
708
709
710
714
712
713
714
715
716
717
718
719

720°

721
722
723
‘724
725
726
727
728
729
730
731
732
733
734
735
. 736
737
738
739
740
741
742
743
744

745

746
747
748
749
750
751
752
753
754

oRAnnaaAaANn th

subroutine adummy
cliche storage set up here

cliche param ;

parameter (izx=150, jrx=50, tzx2=tzx-2 )

parameter ( itbw=2kizx-1  )

parameter (kxp=(izx-2)8(jrx-2), tbwetizx-1 ,jbw=jrx-1)
parameter (kbw=(ibw/jbw)*(jbw-ibwi/(jbw/tbwtibw/jbwitibw }
‘parameter (ida=3%*kbw+1)

parameter (nplt=3000, nps=100 }

parameter (ixpf=4"(tzx-2) ,nfourxf= 150)

wee special version for large grid, no fourter analysis

parameter (ixpf=2,nfourxf=2)
parameter (ixpg=ctizxed)
parameter (neng=500)
parameter (ksim=51)
endcliche
cliche fstor
use param.
common/fun/fllizx, jr) falizx,jex), f3lizx,jex), f4alizx, gre)
ec ,f5lizx, jee) fF 7Cizx jer),
e gllizx,jrex),ge2lizx,jrxl,g3lizx,jerx) g4lizx,jrx)
c ,swgl,swg2,swg3,swg4

common/equil/blizx,jrx) rholizx,Jrx), qublizx,jrx)l clizx,jrx)
ec ,philizx,jerx),yyylizx, jew), xxxlizx,jex),qvlizx,jerx)
common/pertur/xrioolkxe) ,xtolkxp), xiol ikxp)

c. ,xrool(kxp) ,xrolkxp),xrol(kxp)

endcliche

cliche matrix

use param
common/coeff/allkxp,9),a2(kxp,9),adl(kxo,9),bitkxp, 3)
ce ,rhst(kxp) .rhs2(kxp) ,abar(lda,kxp), ipyvt(kxp) , zwork(kxp)

»eee.unnamed common for dynamic memeory expansion

common ww(1},° wwil(1t)
andcliche

cliche const
use param
common/title/aname(5)
commorn/con/gami ,gam2,ix,jx,mm,izxp,kxx,nmax,lmax,isw, ihbw
ec ,facl,fac2,bias,du,dv,dt,ndiag,ex0,b0,rhoO0,ex1,fil,fizx,fjl
e ,fjrx,kKplot,npm,fpsi,fz,fu,fv,azm,apsim,u0,v0,amass,nengx
c ,fourpi,omegst,omegr ,omegexb fir, ,sf6,sfB kplotm,kzs, zedge
c ,cpuoc,cio,syso,valfk,xu,xv,n,pi,vw.,psiw,dvin,dvout, Iltt,nen,
common/contm/ ;
psiOrel,zirel,z2rel,z3rel,z0rel nslosh,bmg
sncenter ,pslosh,peenter,rp,ztrans,ltrans,bm,ltran,ztran rp
,bcen,pring,epsp,phicen,phiplg, kin, xpot, ypot, woot, pfudge, rpx
‘phice, phipl betslish,betcent,z0,21,22,23,z4,psid
,betcene, betslse, psloshe, pcentee, bmax. A4alsit,bm1l,psist,cold

a0

ipsiOerel ,pside psime, p2ewide,wpo2e,p2floor plfloor,peflag
fring, long,no3d;jnold,dphi dtp ,psistr,psisip,psihrel,psih
,dpsihrel ,dpsih

common/pcons/at0,bt0,ct0,cp0
.apl,ap2.ap3,ati,at2,at3,bpl,bp2,bp3,bt1 bt2,bt3,cpl,cp2,cp3

rmann

.betrap,betpas! ,bvx2,bvx3,ncoil,z2ct
common/mesh/osiljerw), zlizx) ,ulizgx) .vljerxw) ,dpstljrx) ,dzitz«)

‘p2wide. psi3rel,psi3,ptmax,bv0,bv3,bv4,beeng, psloshin, ps!loshen
insloshin,pxp1,pxp2,p3a,p3b,p3e¢,p3d,psim,pel0,ael .bel,cel,del

petl ct2,ct3,bmx«1,bmx2,bmx3,bmni,bmn2,ppasl,ppas2,ppas3,pltrap
.z1c,z2c,z3¢,z1imin,z2min,as(3) ,ais(3),2z5(3),bs(3),dpasl dltrap

C

Cc
x
G

q
in

GB

Conon

onoonnnananan

iypsi(jex) uuz(izx)  vpsthi jes) wuzh( tex)

common/graf/ xrtimel(nplt) xrspzllzx,nps) xesppst(jrx, 2knps)
itimel(nplt) xflute(izx ops! ,enpot(neng!, tenergy(neng!
renkinineng), timengy(neng!, tenrel (neng!, enbendineng]
rencurvel(neng! ,enflrineng!)

common/curveo/er, lb, rw, beta0,delrho,stable,enO,cee,rO,
echarg,omegl,omeg2, ent, besarg,zol ,dtrel,p0,omegO
,omanal,omanad,groana, theta

common/tmeon/hial(tzx) hztOllzx) h34d(izx) abpltzx) , bbp(tzx)

‘ppp (tax) abe (tex) bbe lize) cbf lian) hpstirs!

rhtrans(t2x) ,abqlizx)  bbaqlizx) ,cbqltzx),ebp(izx)

efbplizx), gbpiizx), betring, hpOljrx), hem! Irx! shome lox! he r(jex)
h2pOltex). hept(izx), hzp2lizx), hzp3lizx), hztiltzx) ,hzt2(tzx)
shztsltzx)
common/tmfteld/bvac(tzx),dbvdzitzx) ,d2bvdz2(tzx),dptdpsi(jrx]
iplljrxl pikikstm,jerx) bpkOlksim) ,deltt(ksim)

deli2iksim) deltaiksim! delidiksim) rzzlizx,jrxl,dbdpst(izx,Jrx)
rphii(tzxl pht2lizx) pperplizx,Jrx) pparltex,Jrx) dfluted(tzx)
qubv(izx,jrx), peljrx)l dpadpsi (jew) dflutet(tzx) .dflutealtzx!)
iflutel(jrx) flute2(jrx) flute3(jrx) pak(ksim,jrx) deltStksim)
ipperps(tzx,jJrxlv,errprplizx, Jexl,errpel (izx2,Jrx-t) xxxfreq(irx!
ipperpe(tzx,jrx),epst(izx, Jrxl, omegtwkb(jrx) , omegawkb(jrx]
gamwkbljrx),dflute4d(tzx), rhoaveljrx!, xxxavel(jrx), yyvaveljrx]
ipat(jrx),dpadpst(jrx), p3lirx!, dp3dpsi(jrxl, hpkmiks tm!
hpkme(ksim), droave(jrx), drotermlizx), eringllex, Jrx]

grow, growmax, xfreqmax,rzzrmax

common/forzed/nfour ,nfourx,nfourmax,nfourp, J four, txp, lacy

real tb, ltrans,ltran,nslosh,ncenter ,nsloshin
endelitche

return
end

788

789 ci.sc, the main routine

790

7977 OOOO ICIIOIOI IO IOOIOIOIOIOIOIGIOIOIOIOIGIOIOIGIOIOIISIIOIIOIOI III IGIGIOISIOIIGIIOIGIOIGI IR HOIOIOIGIGIOIOI OK
792 c¢ x *
793 ° FLORA is an initial value stabtlity code developed by R, Freis and
794 ¢ B, Cohen, based on Newcomb's long thin axisymmetric formalism, including
795 ¢ finite larmor radius effects, FLORA calculates the linear response to
ras c low frequency perturbations of the equiltbrium magnetic fleld ,

79

VArl- Me CLECESSSSLESSS CLES CS SES ESS CSE C CCE CREPES SECC SEC ESOS CECE SOLES CESESE SST CESSES |
799 c...,4 notice of 4/8/82, this version runs correctly for iswt1, and

B00 ¢..,., runs correctly for tsw=-1 ,

801

B02 c,,.,.,5/12/82, flora runs testcase 1 , 0 beta, 0 pressure, homogeneous
803 c,,,.,., plasma, correctly,

804

805 c,..,, floral transforms variables z,psi to u,v which are always equally
B06 c,,.., spaced, transformation: zzaukuekxu, and psi=apsi*v¥¥xv, where

BO7 c..yey Z2maxzuMax, pSimaxsvmax, and fz¥zmax=fur*umax, fpsi*psimax=sfykvmax ,
808 c,.,... fz, fu, fost, fv, tnput, xuzlm fz 7 tn fu, xveln fpsi 7 In fv,
BOD c,..., AUzUMAKEE(-Kx4+1) | Apst=vmaxk¥(-yy4+T) ,

810

Bll c.i..,. flora2 solves test case 2 , rotating rigid rotor stability, ref:
B12 c,.... fretdberg and pearlstein, phys fluids 21(7) july 1978 1207

813

814

815 c,....flora4 tnceludes background constant density, enbar ( as does flora3 ),
B16 c..,.,. and kzs switch which when set to zero, generates initial perturbations
817 c.,... Independent of z in random spatial generator (exO=1,)

818

819

820 c..... floradS— .

B21 c...., $s vectorized version of florad4 (calls rightvec instead of

822 c,,.... right J. also has timing routine from b. langdon (requires

823 c.,... bzohar loaded as a binary }.

B24 c,...., Insert cliche storage here

825

826

827 c..... flora7 ts mod. flora5, with ps! stretching function

B28 c...., exactly centered in amat. (flora5 used linear interpolation

B29 c., . to get vpst(j+1/2)), Also revised diagnostic plots Included,

830 |

B31 ¢c.,..,.floral2 its floral! (rigid rotor with correrted equil, and

832 ¢c..... corrected curvature terms (floral0)) with fourier mode analyses
833 ¢c..... added ( using cpft and rpft) and data for zed post processing.

834 c..,..,.additional tnput data! jJfour (v tndex at which xr is analyzed in
835 c.....z2 ),.nfourp ( analyze xr every nfour'th time step ),nfourmax

836 c...., (number of times the buffer is read to the history file). note

837 c..... xr is extended a factor of 4 to look like a periodic full wave

838 c,.... for epft. If jfour is imput 0, code sets it to jx/4

839 ¢

B40 c.....floral3 is floral2 with curvature driven flute mode equilibrium

841 c....,lequilrot replaced by equilcur, rigidcon replaced by curvecon }

842

B43 c....,floratm, tandem mirror equilibrium

B44 «

845 c.....flortml, tandem mirror equilibrium, with 3-d plot of equilib.

846 ¢ quantities added. ( uses tv80 and graflib |)

B47. ; .

B48 c...... flortex, tandem mirror equilb, with corrections to flortmi. In-
B49 c..,.... put switches swg1l, swg2, swg3, swg4 added.

850

B51 c....,flortm2, like flortex with revised electron ring, a la D'ippolito
852 ¢c,,.,., leering pperp in b field only, and additional term in curvature

853 ¢c,,.,.. drive J,

854

B55 c,..,,flortm3, like flortm2 with corrections to pressusre normalization,
856 c..... and addittonal diagnostics, ( 3-d plots of curvature drive-e ring
B57 c,.,.,. term, and perp, pressure balance check } . also 3-d plots of

858 c...,, pparallel pressure check, and e-psi (=-dphi/dpsi } , Phi2 modified
859 c...,, to = l,-lpsi/psi3)**ypot , . ;

860

B61 c,....flortm4, modified plasma pperp with addition of p3l(j)} to give

862 c,..,. a positive slope near the center,

863

B64 c..,,,flortm5, modified pl tn flortmd to be two functions, pel and

865 c.,.,. ped, Joined at psime with equal slope and value.pel=aettbel * |

eee Cosre, pst/psimel+ceikl(psi/psime)*#2, and pe2=,5%(1-tanh((psi-psi0e)/p2ewide) |
S67 ¢

868 c...,, flortm6, modified flortmS as follows: for p2(psille. to p2fiag ( an
869 c,.... Input value), p2 set to p2floor (an tnput value) and pl set to

870 c...., plfloor (an input value). Long-thin ering option added, This modifies
B71 c..... b dependence of ering pperp to look longer (by changing abf, bbf, cbf}
872 c...., If long ( an tnput value ) = 1, otherwise leaves pperp of ring un-
873 c...,. changed, Plot output options, notd=1., prevents graflib plots, no3d=1
874 ¢c,...,. prevents tvB0lib 3d plots.

B75 c« ;

876 c..... flortmB (18 for larger psi grid) modified flortm6 as follows;

B77 cy... the analytic calculation of gamwkb corrected to include drho/dps!
B78 c,.... term (tmportant tn the limit of large exb rotation), also phil

879 c...., changed to be constants tn core and plug ( phicen [tn core, and

880 ¢c..... phicentdpht in plug, dphi a new input variable’ !}, Also b calculated
8B1 c,..., with expansion in low beta regions. -

882

883 c..... flortn8, like flort!B with first order energy check added ,

884

885 .

BB6 c,....flrmi like flortnB with multi region equilibrium,

-8B7 c..,... Bvae ts generated from 3 solonoids ( 1 choke coil and 2

BBB c.., mirror cotls), Pressures are the sum of passing and trapped

889 c..... components, See the glossary of input parameters in subroutine

890 c...,.. inputtm for the revised list

891

B92 c...,..flrm2, either 2 or 3 regions, depending on the number of solonotds
893 c..... specified (ncotl=2, or 3) Im the input. For neoil=2, no passing
894 ¢... pressures are allowed, and the situation is similar to earlier

895 c..... versions, except that the vaccum fields are generated by solonoids
896 c..,.. Instead of circular filaments.

897

898 c..... firm3, like flrm2 with corrections to energy subroutine, Also

899 c,.... option to remove hollowness from pperp psi profile (dip=0,), and
900 c..... ering psi profile changed from quadratic to cubic tn inner region.
901

902 c....,.flrm4, cold plasma halo modeled by changing zmax boundary candittions
903 c.,... for psi > psih (psthrel an input parameter |

904

905 c..... filrm6, like flrm4 and flrm5, (mixed boundary condition at zmax,

906 c..... higher order b. ¢,) with special yyy to force “rigid mode” in psi.
907

908 ¢,.... firm7, like flrm6 except phil, p2, yyy restored to original functions
909

910 c,....flrm8, like flrm7 with error in qub corrected to read

911 ci.aes qub=(b**2-ppart+tpperp)/b . (it was qub=(b**2+ppar-pperp)/b)

912

913 c.....flem9, like flrmB with error in gl (curvature drive term calculated
914 ¢..... in fltol1 |} corrected. Error appeared for cases with grid stretching.

31° c..,,:Also added dpas! to region 0 as a constant density,
16
917 c.....flrmi10, like fFlrm9 with errorend added if equilibrium tries to
918 c.,.,.. generate negative square roots in calculating B ,
919 c...,. Diagnostic message sent to terminal, Also added, maximum xxxfreq
920 c...., (flr real frequency * dt}, and maximum rzz¥r. which with grow
32! C.yvees And growmax are sent to the screen and 1I-d graphics ,
922
923 c.....flrd10, changed matrix solution method from banfac, bansol to ltnpac
924 c.,..,, package sgbco in order to use the cray 2-b machine,
925 ¢,.. This ts still a direct Ju factorization method, Elliminated dynamic
926 c...., memory calls, Changed sub comat to pack the diagonals of the original
927 c.,..,. banded matrix tn rows for sgbco, (Sgbco is tn omnttibl,
928
929 c...,.,flrd11, tmproved the accurracy of calculating line integrals
930 c,..,., flutel,flute2, flute3,rhoave, xxxave, yyyave,droave by assuming
931 ¢c..... @ quadratic integrand from z=0 to z(1),
932
933 c.,... flrdl2, for Kzs=1 (input), a "stiff" tnittal radial perturbation
934 c...,, {ts used, This ts of the form xro=constant for psi < psit0O and
935 c,,... goes linearly to O for psitO < psilj) < psiljx) .
936 use param
937 use fstoar
938 use matrix
939 use const
940
941 data tim/1,e6/
942 integer tallyb(2000b)
943 common / gBtocs/tocf (0:15)
944 common/pict00/npete
945 data itally/1/
946
947 c,....,call link call here
948 call tink unt tS59=terminal ,unit2=linfld12,open) ,unit3=(output,
949 c create) //')
3950
951 iflitally.,gt,0) then
952 do 200 it=1,15
953 200 ifliocflti)d.,eq,O)lgo to 210
954 +120
955 210 toctally=ti
956 joctally=14
957 ifltectally.eq.Olgo to 299
958 ¢ call timer(ioctally, 'ztally00',tallyb,2000b,floratim,1)
959 299 }jtally=-t .
960 endif
961 iswel
962 iflizx.gt.jrx)diswe-1
963 Jtbw= Se(1+iswltitbw+ .5*(1-tsw)k(2kjrx-1)
964 -thbw= 5a (1+iswltibw+ Sk(1-isw)k(jre-1)
965 nnzjtbwtkxp
- 966 nni=jtbwtekxp
967 namelist/noplot/nold,no3d
368 call ddi(noplot,2,0,0)
969 if(notd,ne.lical!l pstartidev,4rplot,1,'box u21$',1)
970 ¢ npete=1
971 if(nold,ne,t)call p100
972 call input
973 call inputtm
974 ¢c....., temporary input to test three region model
975 ¢ call tnptemp
976 ¢ call rigidecon
977 ¢ call curvecon

978 call constant

Cee eae

Cee

90

100

300

ie)

special version for testing fourter analysis and zed file

call tmeor2
call equtltm
call equilrot
call equtleur
call fltoll
call amat
ml lskbw
\dal=lda
call comat
call tnittal
maker
eall fourplay
call fourter
call mymovelxrol(1),xrol(1) ,Kxx)
call mymove(xiol(1),xto(1),kxx)
if (kzs.eq.1) then
call mymove(xrool(1),xrol(1),Kxex)
cal! mymovelxtoolt),xtol1),kxx)
endif
call sgbcolabar, |ldal,kxx,ml1,ml1,tpvt,rcond, zwork)
call energy
t=0,
do 100 n=1,nmax
t=t+dt
time(n)=t
facl=-1./dt
fac2=1,/dt

do 90 |=0, |max
call rightvec

call sgbsltlabar, ldat,kxx,mli,mll,ipvt chs? ,0)

call zmovewrd(xrol,rhst,kxx)

call sgbsllabar,ldal,kxx,mlt,mil,ipvt,rhs2,0)
call zmovewrd(xtol,rhs2,kxx)

faci=-,5/dt

fac2=,5/dt

call zmovewrd(xioo,xto,kxx)

call zmovewrd(xio,xtol,kxx)

call zmovewrd(xroo,xro,kxx)

call zmovewrd(xro,xrol,kxx)

time array
xrtimel(n)=xrol(kplot)
if (mod(n,ndiag).eq,O)call diagno

if(mod(n,nfourp).eq,Olcall fourier
Tf (lmodin,nenl),eq.O),or (i tt.ne,O) ,and,(lee,le,neng) ical |

continue

call eclsdskltocv,0}
call timeusedlicp,to,isy)
cpuo=tcp*tim
clo=fioktim
syso=isy*¥tim
iflnotd.ne.1)

call picsher

call close(100)
if(no3d,eq.1}go to 300
call keep80(1,3)

call fr80id

call threed
call plote
continue

call timend
call exit(1)
end

1042 subroutine amat

1043

1044 ¢,,.,, calculates the matrix coefficients for al, a2, a3, bl, be
1045 cis.es Im the equation alkx(n41)=a2tx(n)sazex(n-Tl+b y(n) eb2eyln-t) ,
as Cys... uses fl to F117 from subroutine fltoll and equilibrium quantities,
1
1048 ¢...,, cliche storage here

1049

1050 use param

1051 use fstor

1052 use matrix

1053 use const

1054

1055 dimension beljrx}) ,delcolljrx),delco2l(jrx)

1056 data unit/1,

1057

1058 gam3=-gam2

1059 du2=duk*2

1060 dt2=dtxx*2

1061 _ dv2eadv%%2

1062 dvt=2.%dv

1063 mo=mmee2

1064 Jxejrx

1065 Ixetzx

1066 do 10 {#2,tx-1

1067 do 10 je2,jx-1

1068 kK1si-te(y-2)e(tx-2)

1069 kK2=j-1+ljx-2)"( 1-2)

1070 k=, 50 (1+iswlkk1+.5*(1-tswl tka

1071 r2=r(i,j)**2

1072 vp=vpsi(j)

1073 uz=uuz(i)

1074 bijmh=e(blt,j)eblt,j-1))*,5

1075 bijph=(bli jlebli,jp+1))%,5

1076 bipljph=(bli¢1,jethebliet, jdd*.5

1077 biptjmh=l(bli+t, jrTi+bli+t, ple ,5

1078 bimljphe(blt-1,j+etl+b(t-1,j))",5

1079 bimtljmh=lb(t-1,j-1Tle+bli-t,j))*.5

1080 gAiphjph=(gdli+1, jellegd4li  plegAlitt, Jleg4li, pet) )*. 25%uuzh(i)
1081 gAiphjmh=(g4( itl, Jr tiegdhli , plegalie1, pleg4lt,p-1))%, 25*uuzhli )
1082 SAimhiph=leAlind jollogdtt jleodlt-t Jlsgd li jet) )e, 25kuuzh (4
1083 g4imhimh=l(g4li-t jr-tleg4(t  plegdlt-1,jpleg4lt,p-1))*,25euuzhli)
1084 g2iphj=lg2li+t, jleg2li, jf) )*. Stuuzhli)

1085 gZimhjal(g2li-d,jleg2li,j))*. Skuuzhli-1)

1086 gsiphjelg3lie41,p)eg3li, jdie. Skuuzh(7)

1087 g3imhjel(g3li-1,jpleg3lt  plde Seuuzhli-1)

1088

1089 Fligph=(fF1T(i, plot (i, fel) )*. Sevpsihty)

1090 flijmh=(fF Ti, pleft (i, sel) )e Savpsihl(y-t)

1091 FStpph=alFSli, GleeS li, pet) Skvpsih(s )

1092 FSigmh=a(F5(t GlefSlt, jr-1bde. Se. psthlj-1)

1093

1094 iflj.gt.2lgo to 60

1095 flijmh=0,

1096 fEijmh=0.

1097 60 continue

1098 uzbar=-uuzli ler lt, j)/(du2kdve2)

1099 al(k,1)e-gamitbimijmh*g4imhjmh*tbi jmh*uzbarkvpsih(j-1)

1100 c ¥rli-t,j-1)

1101 a2Z(k,1)=-gam2tbimijmh*g4imhjmh*bi jmh*uzbarkvpsih(j-1)

1102 ¢ ¥r(t-1,j-1)

1103 a3l(k, 1)=-gam3tbimijmh*g4imhjmh*bi jmh*uzbarkvpsih(j-1)

1104 ec ¥rli-t,j-1)

KM AM HHHOMOOCMMUUMNMVUMNUMNEERBSBEREABREARERERWWWWWWWWWWNHNNNNNNNYN =o e soo uu Qo000

al(h QVE-F Vip mh/ ( (dt ¥dv I ke2) +gamIe( FSi jmh/dv2tbs jmh¥*2kuzbar
¢ ¥vpsth(j-T)¥e lh, jr Viel gd4imhjmh+g4. phjmh) }
a2(Kh, 2I=-F Tt pmb ( (dtedvl ¥e2)+gam2e(F5tjmh/dv2+bi jmhe*2kuzbar
¢ ¥vpsthlj-1)er (i, J~T del gAimhjmh+g4iphjmh) )
aS(k 2)=-FTij mh ( (dt adv) e#2)egam3e( FSi pmh/dv2+bi jmh**2kuzbar
c ¥vpsth(j-V)erli  J-1) el gdtimhimh+g4iphjmh) )

al(k,3)=-gami*tbiptjimh*g4iphjmhebijmh*uzbartvpsth(j-1)erlt41,j-1)
aZ(k ,3)=-gemetbipljimh*g4iphjmh*bi jmh*uzbarktvpsth(j-1)*el +1, 5-1)
a3s(k, 3)=-gam3tbiplimh*g4iphjimh*ebijmh*uzbarktvpsihi j-1)erli+t, j-1)
ait(k, A)=egam1¥((bimljmh¥gdimhjmhtvpsth(j-1)#bijmh+bimtjph*g4imhj ph
c tvpsih(j )*bijph) kuzbararli-d, jbemmexenb (i,j) *uzbarx
c g2imh} #g3(i-1,$) #dv2/vpsi tj) )
a2(k 4)=egam2k((bimltjmh*gdimhjmhevpsth(j-T)ebijmhtbimijph*g4imhjph
c ¥vpsthl(j )*btjph) *uzbar xe (1-1, 5 )emmee2eeb (i,j )*uzbarx
¢ g2imhj¥*g3li-1,j)*dv2/vpsi(j))
a3(k ,4)=gam3e((bimljmhaegdimhjmh¥vpsih(j-1)*bijmh+tbimijph*g4imhjph
c ¥vpsth(j )*bijph) tuzbar er (i-1, jf )emmek2eb( i,j) kuzbarx
c¢ g2imhj¥g3li-1,j )*dv2/vpsi(j))

al(k Sa (lFligphefligmh) /dv2-f2(1, jp) )/dt2+¢gamial-(f5ijph+Ff5ijmh
c )fdv2tf7(t,plegt lt, jlel-bijmhex2n(gd4imhjmh+gd4iphjmh) *vpsihl(j-1)
c ~bijph*®*2*(gdimhjipht+g4iphjph) *vpsih(j))*r(t, jf) *uzbar-

c mmeeoueb( {jj )kuzbare(g2imhj+g2iphj }¥g3li,j )*dv2/vpsil(j))

a2(k Sell Flijpheflijmh)/dv2-f2li,jpli/dt2+gam2eel-(f5ijph+fSijmh
c )/dv2+f7(t,plegtli, })4(-bijmhex2"( gdimhjmh+gdiphjmh) #vpsth(j-1)
c -bijph*e2e(gdimhjph+gdiphiph)*vpsthij))eeli, j )*uzbar- ;
c mmk&R24b(1,j )Fuzbarrx(g2imhj+g2iphj )*g3li, j)edv2/vpsilj))

astk SI=z((Flijphetlijmh)/dv2-f2li, pl) /dt2+gam3xl-(€5ijph+fSijmh
c V/dv2eF 701, Jltgtii,j)+(-bijmhex2e(gdimhjmh+gdiphjmh) #vpsth(j-1)
c -bijph**2«(ghimhjph+gdiphjph)*vpsth(j) eri, j )*uzbar-
c mm¥k2tb (1, j )*uzbark*l(g2imhjtg2iphj )*g3li,ji*dve/vpsi(j))

al(k Gl=gam1¥((bipljmh*gdiphjmh*bijmhkvpsih(j-1)+bipljph*g4iphjph
¢ *bijph*¥vpsih(j) )kuzbar er (i4+1,j )+mmee2eb (i,j )*uzbar x

c g2iphj¥g3li+t,j)¥dv2/vesi lj}!

aZ2(k 6) =gam2k((bipljmh*gdiphjmh*bijmh*vpsihij-1)+biptjph*g4iphiph
c Xbijphevpsth(j) )kuzbarke (i), j )¢mmee2eb (i,j) tuzbark

¢ g2iphj*g3li+1, j )*¥dv2/vpsilj))

a3(k, 6 )=gam3x((bipljmhtgdiphjmhxbi jmh¥vpsihi(j-1)+biptjphxg4iphiph
c abi jphtvpsth(j))*uzbarxr (1 V plemmee2kb l(t, j ) *uzbart

c g2iphjxg3l itt, j!#dv2/vpsi (ji)

al(k, 7legam1*l-bimtjph*gdimhjph*bijph*vpsih(j )*uzbarer(i-1,j+1))
a2(k,7)=gam2*(-bimljph*gdimhjphebijph*vpsih(j }*kuzbarer(i-1,j+1))
a3(k,7)=gam3¥*(-bimljph*g4imhjph*bijph*¥vpsih(j )*uzbarterl(i-1,j¢1))
atik, Bl=-F1ijph/(dt2%dv2)¢gam1*(F5ijph/dv2+(bijph#*2"(gdimhjph
c +ghiphjphi*vpsthlj )¥eli, j+1)*uzbar))
aZ(k, B)=-f li jph/(dt2%dv2) ¢gam24(f5i jph/dv2+(bi jpht#24(gdimhjph
c +gdiphiph)¥vpsih(j ltr (i, j+1)*uzbar))
a3si(k, B)l=-Flijph/(dt2%dv2)+gam3x(f5i jph/dv2+(bi jphk#2*(g4imhj ph
c. +gdiphjph)*vpsihijlxrti, J+l)¥uzbar))
ai(k, Q)=gamiki-bipljphtgdiphjphtbi jph*vpsih(j kuzbarar (ie, j*t))
a2(k , Il=egam2el-biptjph*gd4iphjph*bijph*¥vpsihij )*uzbar¥rli+t,j+4t))
a3(k,9l=gam3*(-bipljph*g4iphjph*bijph*vpsih(j )*uzbarer(i+t,j+1))
..+..61 array for rhs
f3ijmh=(F3CT, Glef alt, j-1))*.5¥vpsih(j-1)

F3ijph=(F3(T, fF I+FS(i, fot). Skvpsih( i)

denom=1,/(dv2)

bik, TI =f3t imh¥denon

b1(k,3)=f3ijph*denom

bi(k,2)=-(f3ijmh+f3ijph-f4li, J) *dv2/vpi*denom

ao

{ome ee ae ae ee se ss es ow wns a as ws es a ss ss a a es a se a

1201

n

10 continue
wea Correct coefficients on boundaries
sfil=sign(unit, fil)
sfjl=esitgn(unit,fj1)
sfirxestigni(untt, firs)
sfizx=sign(unit,fizx)
veeey BSOt corners to 0
kK1teix-2
K1pele(tx-3)a(jx-2)
ki=, Se(T+iswhtk tie, 5*(1-tswlktk1j
facta
fisf}1.eq,1,and, sfizx.eq. ti facter (txt 2leb(in-t,21/
c Metin orebtie i
at(k? Sleal(kt,5)¢facteat(kt, 3!
a2(k1,5)2a2(k1 5) +fact*a2(k1,3)
a3(k1,5)=2a3(k1,5)+fact*a3(k1,3)
ai(k1,3)=0,
gtk ated,
3(k1,3)20,
K2tetel ined px (jx-3)
kK2j=jx-2
K2=.5K(1+isw)#k2i¢, 5a(l-iswlkk2j
fac3=-dvout/dvin
if(sfjrx,eq. land, sfil.veq.d)fac3=r(2,jx-1)¥*b(2,jx-1)7
ec (rll, jw-T)eb(1,j5x«-1))
al(k2,5)2at(k2,5) +facdeal(k2, 7)
a2(k2,5) za2(k2, 5) +facdkea2(ke2, 7)
a3{(k2 5)=ad(k2,5)+fac3*a3(k2,7)
at(k2,7)=0,
a2(k2,7)=0,
a3(k2,7)=0,
fac2=-1,
ifisfjlreq.l.and.sfil.eq, 1) fac2=er(2,2)eb(2,2)/l(r (1,2) %b(1,2))
a1(1,5)2a1(1,5)+¢fac2¥*ai(1,1)
anti Biragi 1 Bletacataatt, 1
3(1,5)=a3(1,5)+fac2*a3(1.1)
anit it)s0,
agit tise.
3(1,1)=0.
facde-dvout/dvin
ifisfjrx.eq.1iand.sfizx.eq. 1) facderlix-1,ju-T)eblix-1,jx«-1)/
c (rlix,jx-T)eblix,jx-T))
at(kxp,5S)=all(kxp, B)+facdkallkxp, 9)

a2(kxp,5)2a2(kxp,5)+fachka2(kxp, 9)
as(kxp,S)ea3(kxp, S)+fachkad(kxp,9)
alikxp, 9120,
a2ikxp,9)=0..
a3(kxp,9)=0.
t=2
do 11 j#2,jx-1
if(sfil.eq. 1. isfiler(2,j)eb(2,j)Z(r (1, j)*b(1,5))
k1ei-lelj- =2)#(Tx- -2)
K2=j-14(jx-2)*"(1-2)
k=. 54(1+isw)tk1+¢.5*(1-isw) *k2
do 11 m=2,8,3
al(k mi=al(k ml+sfil*alik,m-1)
a2(k,m)=a2t(k, mitsfilkactk, m-1)
a3(k m)=a3l(k mitsfil*tas(k,m-1)

11 continue

13. continue
teix-]
do 12 j=2,jx-1
be(j}=0, .
if(psilj). lt. lpsth-dpsith) }be(j)=1.

1233 ¢ iflpsilj), ge, (psth- dpsth).and,pst(j).le.,(psth+dpsth) |
1234 be lj )=.5"(tanh( (-psiljl¢psth)/dpsth) + 1)
1235 rbter(ix-1,j)*b(tx-1,5)

1236 rotler (ix, j)¥blix, 5)

1237 ,down2=8, *be lj )*uuzh(tx-1)/dut43,*(1,-belj))
1238 -up2=t.-belj)

1239 gm2=up2/downe .

1240 upt=-up2¥rbt1*, 75¢+be (jf) erbt*uuzhl(tx-1)/du
1241 downl=(be(j }*¥uuzh(tx-1)/du+up2*3,/8, )¥rbti
1242 gm1=up1/downt

1243 delcol(j)=gm1

1244 delco2(j)=gm2

1245 upzl(belp)er(ix-1,jp)ebltx-1, | )euuzh(ie-1)/dutebtxlbe(j)-t. 1)
1246 down=(beljl&r(ix, J )¥b4ti a Kuuzh(ix-1)/dutrbt*(-be(j)+t.))
1247 sf itzx=up/down

1248 K1=t-14(j-2)alix-2)

1249 kK2=j-14(jx-2)e(4-2)

1250 = Se (i+tswltk1+ Se(1-tswl¥k2

1251 do 12 m=2,8,3

°1252 al(k ml=all(k mitgmt¥at(k mel) .
1253 atik,m-T)}=altlk ,m- 1) ¢gm2tat(k, m+1)

1254 a2l(k miza2l(k ml+gmi¥a2l(k, met)

1255 az(k  m-T)=a2(k,m- 1)egm2xa2(k, m+1)

1256 a3(k,m)=a3(k m)+gm1*a3(«, m+)

1257 a3l(k  m-1)=a3(k -m- 1) +gm2ta3lk, m+)

1258 12 continue

1259 20 continue

1260 1=2 ,

1261 do 21 jz2,jx-|

1262 kK1=i-14+(j-2)"(ix-2)

1263 | K2ej-14+( fx -2)"( 1-2)

1.264 k=, 5e(1¢isw)tk1+,5*(1-tswl¥k2

1265 do 21 m=1,7,3

1266 at(k,m)=0,

1267 .  a2lk,m)=0.

1268 a3(k,m)=0.

1269 21 continue

1270 t=tx-1

1271. do 22 j=2,jx-1

1272 K1=t-1+(j-2)"(tx-2)

1273 kK2=j-1+ljx-2)e (5-2)

1274 k=, 54(1+i sw) tk14.5*(1-isw)*k2

1275 do 22 m=3,9,3

1276 alt(k,m)=0

1277 a2(k,m)=0

1278 a3(k,m)=0

1279 22 continue

1280 jz2

1281 do 31 ft=2,ix-1

1282 K1=t-14(j-2)elix-2)

1283 kK2=j-14+ljx-2)e( 4-2)

1284 K=,5e(1¢isw)ltk1+,.5e(1-tswltke

1285 do 30 m=4,6

1286 al(k,ml=al(k ,mi+tsfjieat(k,m-3)

1287 a2(k m)=a2(k miesfjil*ea2(k m-3)

1288 a3(k , mil=a3(k ,m)+sfjl*a3(k ,m-3)

1289 30 continue

1290 b1(k,2)=b1(k,2)esfji*bit(k,1)

1291 31 continue

1292 32 continue

1293 jzjx-l

1294 fac5=sfjrx

1295 if(sfjrx.eq.-l)fac5=facSkdvout/dvin

1296 do 35 i=2,ix-!

1

44
45

48

continue

bI(k, 2)=b1(k, 2)+facSebi(k, 3)

continue
continue
jze

do 45

2
w
6
(
2 (
(

t=2,4x«-1
K1=t-1T+ljp-2)e(ix-2)
kK2=fri+(jpr-2)*eli-2)

k= 5e(1+iswltk1+.5e(1-iswlkk2

do 44 m=4,6

al(k,m-
a2(k m-
a3ik,m
contin
bi(k,1
Patios.
jejx-
do 48

Be owe!

u
}

}
)
}

0.
QO,
0.

i=2,1

kK1=1-14(j-2
k2=j-14(j

k=.5%(1+4

do 47 m=4

at(k  m+3
a3(k  m+3
a2lk ,m+3

continue

bi(k,3)=0

continue
return
end

|

}
}
)

x
Sw
'

w
6
QO.
0
0

1K

“Ba 1-10) tk2
imi¢facS*atl(k ,m+3)

miefacSkea2(k  m+3)
a3(k, m)=a3 k, m)+facskaal(k.m+3)

)
}
x(1-isw)kk2

1334
1335
1336
1337
1338
1339
1340
1341
1342
1343
1344
1345
1346
1347
1348
1349
1350
1351
1352
1353
1354
1355

COI IOI OOOO IOI IOI IOI OIE

15

subroutine bvcal(bs,zs,as,als,z,n,zc¢0, bec, znorm,bv,bvp,bvpp,
b4,b5,24,2z5,nc)
dimension bs(1),zs(1),as(1),als(1),2(1),b (1) ,bvp(1) ,.bvpp(1)

“call beceal(bs,zs,as,als,z,n,bv,bvp,bvpp,b4,65,24,25,nc)

do 15 t=1,%

beorr=bece

beorrp=0,

beorrpp=0.

tanhyp=tanh( (zt t}o2zcel/znorml

beorrp=-bee® ,5*(1,- tanhyp**2)/znorm
beorrppr+becktanhypklt, ~tanhyp¥#2)/znormee2
beorr=bec*,5*(1,-tanhyp)

bv(tl=bv(il*becorr
byplil=bveli)+bcorrp
bypplil=bvpplil+bcorrpp
iflelil.eq,z4)b4=bA+beorr

if(zlil.eq.z5)b5=b5+¢bcorr
continue

return

end

1356 COO OOOO OIRO IORI IORI IOIOK

1357 subroutine bececal(bs,.5,as,éls,z,n, bv, bvp,bvpp,b4,b5,24,25,nc)
1358 dimension z(n),bvin),bvpin) bvppln)

1359 dimension bs(3),z8(3),as(3),als(3},alphal3,3),ak(3),%s(3)
1360

1361 ¢...,compute matrix elements

1362

1363 do 10 jzl,ne

1364 do 10 t=1,ne

1365 alphali,jl=bfunizslil,zs(jl,alstj),as(j),0)

1366 10 continue.

1367

1368 c...,.determinant

1369 ifinc.eq.2lalpha(3,3)=1

1370

1371 detz=alpha(t,1)*lalphal2,2)*alphal3,3)l-alpha(3,2)*alpha(2,3})
1372 1 ~alpha(1,2)*(alphal2,1)*alphal3,3)-alphal3,1)*alphal2,3))
1373 2 talphall,3)*lalphal2,1)*alphal3,2)-alphal(3,1)*alphal2,2))
1374

1275 ¢,...so0lution

1376

1377 ak (1)=(bs(1)*(alpha(2,2)*#alphal(3,3)-alpha(3,2)*alphal2,3))
1378 1 -bsl2)*alpha(1,2)*alphal3,3)-alphal3,2)*alpha(1,3))
1379 2 +bs(3)*(alphalt,2)*alphal2,3)-alphal2,2)*alpha(?,3)))
1380 3 /det

1381 ak(2)=(-bs(1)*lalphal(2,1)*alphal(3,3)-alpha(3,1)#alpha(2,3))
1382 1 +bs(2)*(alpha(1, Vi eateha(s. gi -alphal3. 1)*xalphal1,3))
1383 2 -bs(3)e(alphal1,1)*alpha(2,3)-alphal(2,1)}*alpha(1,3)))
1384 3 /det

1385 ak (3}=(bs(1)#lalphai(1,2)*alphal2,3)-alphal(1,3)*alphal(2,2)}
1386 1 -bs(2)*(alpha(1,1)¥*alphal2,3)-alphal1,3)*alpha(2,1))
1387 2 tbs(3)*lalphal1,1)*alphal2,2)-alphal1,2)*alpha(2,1)))
1388 3 /det

1389

1390 c....fields and derivatives

1391 .

1392 do 50 i=i,n

1393 bv(t)=0,

1394 bvp(i)=0,

1395 bvpp(i)=0,

1396 do 50 j=tl,ne

1397 bvlil=ebvlileak (js) ebfunl(zlt),zsty), atstjtasti).0!

1398 byplil=bvp(i}+ak(j)#bfuniz(t), eet), als(j}.as(j),1)

1399 bvpplil=bvpplil+ak(j)tbfun(zli),zs(j),alasj},as(j),2)

1400 50 continue

1401

1402 c....minima and their positions

1403

1404 -do 70 jFt,nc

1405 do 60 i=2,n

7406 if(zs(j).lt.zlid) go to 63

1407 60 continue

1408 63 is(j)=i-1

1409 70 continue

1410 b4z=aminaflbv,is(1),is(2),1,i4,amin)

1411 z4=z(i4)

1412 . tf incotl.eq.2)return

1413 b5= aminaf (by, is(2),18(3),1,15,amin)

1414 z5=2z(15)

1415

1416 return

1417 end

COICO UII IOIOIIOIIOIOIOIOIOI FOIOICIOIDIGIDIOIIOIOIOIDIOIDIGIDIDIGIDIOIDIOIOIGIOIOINIOIGISIOIDIOIIOIOI IODIDE

20

30
40

function bfunl(z,zx%,al,a,ind)
ind1l=ind+1

up=zx+,5kal

um=zx-,5eal

go to (10,20,30),ind1
tl=gfun(z,up,a)

t2=gfunl(z,um,al

go to 40
tl=gfunt(z,up,a)
t2=gfunt(z,um,al
go to 40
tl=gfun2(z,up,a}
t2=gfun2(z,um,a)
bfun=(t1-t2)/akx2
return
end

1435 COCO JOO IOIOIIUIOIIOIIIOIOIOOIOIOIOIOIOIIOIIIOIOIOICIOI IOI IDIGIOIOIOIGIGIOIOIOIOI

1436 function gfun(z,u,al}
1437 xlFu-z

1438 x2=sqrt (x1ek2+aeK2)
1439 afynexl/x2

1440 return

1441 end

